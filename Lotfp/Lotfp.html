<div class="sheet-2col">
    <div class="sheet-col-left sheet-noborder">
         <!-- LOGO -->
         <img src="http://i.imgur.com/uwl3LKE.jpg" class="sheet-logo">
    </div>
    <div class="sheet-col-right sheet-noborder">
         <!-- Header Content -->
         <div class="sheet-info-name sheet-info-margin">
             <span>Name: </span>
             <input type="text" class="sheet-bottom-line" name="attr_name">
         </div>
         <div class="sheet-info-row">
             <input type="text" class="sheet-info3" name="attr_class">
             <input type="text" class="sheet-info3" name="attr_level">
             <input type="text" class="sheet-info3" name="attr_alignment">
             <span class="sheet-info3">Class</span>
             <span class="sheet-info3">Level</span>
             <span class="sheet-info3">Alignment</span>
         </div>
         <div class="sheet-info-row">
             <input type="text" class="sheet-info2" name="attr_age">
             <input type="text" class="sheet-info1" name="attr_sex">
             <input type="text" class="sheet-info3" name="attr_xp">
             <input type="text" class="sheet-info3" name="attr_nextxp">
             <span class="sheet-info2">Age</span>
             <span class="sheet-info1">Sex</span>
             <span class="sheet-info3">Current XP</span>
             <span class="sheet-info3">XP for next Level</span>
        </div>
    </div>
</div>
<!-- ABILITIES, SAVES, ETC -->
<div class="sheet-2col">
    <!-- ABILITIES-->
    <div class="sheet-col-left sheet-thick-border">
        <!-- ABILITIES -->
        <h3>Abilities</h3>
        <div class="sheet-flex">
            <div class="sheet-ability-column-value">
                <span>Charisma</span>
                <input type="number" class="sheet-ability-value sheet-text-appearance" name="attr_cha" value="10">
            </div>
            <div class="sheet-ability-column-modifier">
                <input type="number" class="sheet-ability-modifier sheet-text-appearance" name="attr_ChaMod" value="(round(@{cha}*@{cha}*@{cha}*0.002831-@{cha}*@{cha}*0.08918+1.164*@{cha}-5.667))" disabled="true">
                <span class="sheet-subtext">Ret. Recruitment, Loyalty</span>
            </div>
            <div class="sheet-ability-column-roll">
               <button class="sheet-ability-button" type="roll" value="&{template:lotfp_check} {{name=Charisma}} {{abilityroll=[[1d20+[[@{ChaMod}]]]]}}" name="roll_ChaCheck"></button>
            </div>
        </div>
        <div class="sheet-flex">
            <div class="sheet-ability-column-value">
                <span>Constitution</span>
                <input type="number" class="sheet-ability-value sheet-text-appearance" name="attr_con" value="10">
            </div>
            <div class="sheet-ability-column-modifier">
                <input type="number" class="sheet-ability-modifier sheet-text-appearance" name="attr_ConMod" value="(round(@{con}*@{con}*@{con}*0.002831-@{con}*@{con}*0.08918+1.164*@{con}-5.667))" disabled="true">
                <span class="sheet-subtext">Hit Points, Daily Travel Distance</span>
            </div>
            <div class="sheet-ability-column-roll">
               <button class="sheet-ability-button" type="roll" value="&{template:lotfp_check} {{name=Constitution}} {{abilityroll=[[1d20+[[@{ConMod}]]]]}}" name="roll_ConCheck"></button>
            </div>
        </div>
        <div class="sheet-flex">
            <div class="sheet-ability-column-value">
                <span>Dexterity</span>
                <input type="number" class="sheet-ability-value sheet-text-appearance" name="attr_dex" value="10">
            </div>
            <div class="sheet-ability-column-modifier">
                <input type="number" class="sheet-ability-modifier sheet-text-appearance" name="attr_DexMod" value="(round(@{dex}*@{dex}*@{dex}*0.002831-@{dex}*@{dex}*0.08918+1.164*@{dex}-5.667))" disabled="true">
                <span class="sheet-subtext">AC, Ranged AB, Initiative</span>
            </div>
            <div class="sheet-ability-column-roll">
                <button class="sheet-ability-button" type="roll" value="&{template:lotfp_check} {{name=Dexterity}} {{abilityroll=[[1d20+[[@{DexMod}]]]]}}" name="roll_DexCheck"></button>
            </div>
        </div>
        <div class="sheet-flex">
            <div class="sheet-ability-column-value">
                <span>Intelligence</span>
                <input type="number" class="sheet-ability-value sheet-text-appearance" name="attr_int" value="10">
            </div>
            <div class="sheet-ability-column-modifier">
                <input type="number" class="sheet-ability-modifier sheet-text-appearance" name="attr_IntMod" value="(round(@{int}*@{int}*@{int}*0.002831-@{int}*@{int}*0.08918+1.164*@{int}-5.667))" disabled="true">
                <span class="sheet-subtext">Saves vs MU Spells, Languages</span>
            </div>
            <div class="sheet-ability-column-roll">
                <button class="sheet-ability-button" type="roll" value="&{template:lotfp_check} {{name=Intelligence}} {{abilityroll=[[1d20+[[@{IntMod}]]]]}}" name="roll_IntCheck"></button>
            </div>
        </div>
        <div class="sheet-flex">
            <div class="sheet-ability-column-value">
                <span>Strength</span>
                <input type="number" class="sheet-ability-value sheet-text-appearance" name="attr_str" value="10">
            </div>
            <div class="sheet-ability-column-modifier">
                <input type="number" class="sheet-ability-modifier sheet-text-appearance" name="attr_StrMod" value="(round(@{str}*@{str}*@{str}*0.002831-@{str}*@{str}*0.08918+1.164*@{str}-5.667))" disabled="true">
                <span class="sheet-subtext">Melee AB, Open Doors</span>
            </div>
            <div class="sheet-ability-column-roll">
                <button class="sheet-ability-button" type="roll" value="&{template:lotfp_check} {{name=Strength}} {{abilityroll=[[1d20+[[@{StrMod}]]]]}}" name="roll_StrCheck"></button>
            </div>
        </div>
        <div class="sheet-flex">
            <div class="sheet-ability-column-value">
                <span>Wisdom</span>
                <input type="number" class="sheet-ability-value sheet-text-appearance" name="attr_wis" value="10">
            </div>
            <div class="sheet-ability-column-modifier">
                <input type="number" class="sheet-ability-modifier sheet-text-appearance" name="attr_WisMod" value="(round(@{wis}*@{wis}*@{wis}*0.002831-@{wis}*@{wis}*0.08918+1.164*@{wis}-5.667))" disabled="true">
                <span class="sheet-subtext">Saves vs Cleric Spells</span>
            </div>
            <div class="sheet-ability-column-roll">
                <button class="sheet-ability-button" type="roll" value="&{template:lotfp_check} {{name=Wisdom}} {{abilityroll=[[1d20+[[@{WisMod}]]]]}}" name="roll_WisCheck"></button>
            </div>
        </div>
    </div>
    <div class="sheet-col-right sheet-save-col">
        <!-- SAVING THROWS -->
        <div class="sheet-thick-border">
            <!-- Saving Throws -->
            <h3>Saving Throws</h3>
            <div class="sheet-flex">
              <div class="sheet-svblock">
                <span class="sheet-svbtitle">Paralyze</span>
                <input type="number" class="sheet-savingthrow sheet-text-appearance" name="attr_Paralyze">
                <span class="sheet-svnsubtext">Mobility Hazards (Petrification, Hold, Etc.)</span>
                <button class="sheet-ability-button" type="roll" value="&{template:lotfp_check} {{name=Paralyze}} {{saveroll=[[1d20]]}} {{target=[[@{Paralyze}]]}}" name="roll_ParalyzeCheck"></button>
              </div>
              <div class="sheet-svblock">
                  <span class="sheet-svbtitle">Poison</span>
                  <input type="number" class="sheet-savingthrow sheet-text-appearance" name="attr_Poison">
                  <span class="sheet-svnsubtext">Instant Death/KO Situations</span>
                  <button class="sheet-ability-button" type="roll" value="&{template:lotfp_check} {{name=Poison}} {{saveroll=[[1d20]]}} {{target=[[@{Poison}]]}}" name="roll_PoisonCheck"></button>
              </div>
              <div class="sheet-svblock">
                  <span class="sheet-svbtitle">Breath Weapon</span>
                  <input type="number" class="sheet-savingthrow sheet-text-appearance" name="attr_Breath">
                  <span class="sheet-svnsubtext">Area Effect</span>
                  <button class="sheet-ability-button" type="roll" value="&{template:lotfp_check} {{name=Breath Weapon}} {{saveroll=[[1d20]]}} {{target=[[@{Breath}]]}}" name="roll_BreathCheck"></button>
              </div>
              <div class="sheet-svblock">
                  <span class="sheet-svbtitle">Magical Device</span>
                  <input type="number" class="sheet-savingthrow sheet-text-appearance" name="attr_Device">
                  <span class="sheet-svnsubtext">Spell-like effects from Items</span>
                  <button class="sheet-ability-button" type="roll" value="&{template:lotfp_check} {{name=Magical Device}} {{saveroll=[[1d20]]}} {{target=[[@{Device}]]}}" name="roll_DeviceCheck"></button>
              </div>
              <div class="sheet-svblock">
                  <span class="sheet-svbtitle">Magic</span>
                  <input type="number" class="sheet-savingthrow sheet-text-appearance" name="attr_Magic">
                  <span class="sheet-svnsubtext">Spells or Innate Abilities</span>
                  <button class="sheet-ability-button" type="roll" value="&{template:lotfp_check} {{name=Magic}} {{saveroll=[[1d20]]}} {{target=[[@{Magic}]]}}" name="roll_MagicCheck"></button>
              </div>
            </div>
        </div>
        <!-- AB AND HP -->
        <div class="sheet-thick-border sheet-flex">
            <div class="sheet-svblock">
                <span class="sheet-svbtitle">Base<br>AB</span>
                <input type="number" class="sheet-savingthrow sheet-text-appearance" name="attr_BaseAB"  value="1">
            </div>
            <div class="sheet-svblock">
                <span class="sheet-svbtitle">Melee<br>AB</span>
                <input type="number" class="sheet-savingthrow sheet-text-appearance" name="attr_MeleeAB" value="(@{BaseAB}+@{StrMod})" disabled="true">
            </div>
            <div class="sheet-svblock">
                <span class="sheet-svbtitle">Ranged<br>AB</span>
                <input type="number" class="sheet-savingthrow sheet-text-appearance" name="attr_RangedAB" value="(@{BaseAB}+@{DexMod})" disabled="true">
            </div>
            <div class="sheet-svblock">
                <span class="sheet-svbtitle">Current<br>HP</span>
                <input type="number" class="sheet-savingthrow sheet-text-appearance sheet-hp" name="attr_HP">
            </div>
             <div class="sheet-svblock">
                <span class="sheet-svbtitle">Max<br>HP</span>
                <input type="number" class="sheet-savingthrow sheet-text-appearance sheet-hp" name="attr_MaxHP">
            </div>
        </div>
        <!-- AC -->
        <div class="sheet-thick-border sheet-flex">
            <div class="sheet-svblock">
                <span class="sheet-svbtitle">Melee<br>AC</span>
                <input type="number" class="sheet-savingthrow sheet-text-appearance" name="attr_MeleeAC">
            </div>
            <div class="sheet-svblock">
                <span class="sheet-svbtitle">Ranged<br>AC</span>
                <input type="number" class="sheet-savingthrow sheet-text-appearance" name="attr_RangedAC">
            </div>
            <div class="sheet-svblock">
                <span class="sheet-svbtitle">W.Shield<br>AC</span>
                <input type="number" class="sheet-savingthrow sheet-text-appearance" name="attr_WShieldAC">
            </div>
            <div class="sheet-svblock">
                <span class="sheet-svbtitle">Surpr.<br>AC</span>
                <input type="number" class="sheet-savingthrow sheet-text-appearance" name="attr_SurprisedAC">
            </div>
             <div class="sheet-svblock">
                <span class="sheet-svbtitle">Encumb.</span>
                <input type="number" class="sheet-savingthrow sheet-text-appearance" name="attr_Encumbrance">
            </div>
        </div>
    </div>
</div>

<!-- WEAPONS -->
<div class="sheet-thick-border sheet-weapons">
    <h3>Weapons</h3>
    <div class="sheet-weapon-title sheet-rep-header">
      <span class="sheet-weaponname">Name</span>
      <span class="sheet-weapontype">Type</span>
      <span class="sheet-attackbonus">AB</span>
      <span class="sheet-damage">Damage</span>
      <span class="sheet-damage">S Range</span>
      <span class="sheet-damage">M Range</span>
      <span class="sheet-damage">L Range</span>
      <span class="sheet-dummy-attack-button"></span>
    </div>
    <fieldset class="repeating_wepons">
        <input type="text" name="attr_weaponname" class="sheet-bottom-line sheet-weaponname">
        <select name="attr_weapontype" class="sheet-weapontype">
            <option value="@{MeleeAB}" selected>Melee</option>
            <option value="@{RangedAB}">Ranged</option>
        </select>
        <input type="number" name="attr_attackbonus" value="@{weapontype}" class="sheet-bottom-line sheet-attackbonus sheet-text-appearance" disabled="true">
        <input type="text" name="attr_weapondamage" class="sheet-bottom-line sheet-damage">
        <input type="text" name="attr_shortrange" class="sheet-bottom-line sheet-damage">
        <input type="text" name="attr_mediumrange" class="sheet-bottom-line sheet-damage">
        <input type="text" name="attr_longrange" class="sheet-bottom-line sheet-damage">
        <button class="sheet-attack-button" type="roll" value="&{template:lotfp_check} {{name=@{weaponname}}} {{charactername=@{name}}} {{attackroll=[[1d20+[[@{attackbonus}]]]]}} {{damageroll=[[@{weapondamage}]]}}" name="Rollb_@{weaponname}"></button>
    </fieldset>
</div>

<!-- SKILLS AND EQUIPMENT -->
<div class="sheet-2col">
    <div class="sheet-col-left sheet-thick-border">
        <h3>Skills</h3>
        <fieldset class="repeating_skills">
            <input type="text" name="attr_skillname" class="sheet-bottom-line sheet-skillname">
            <select name="attr_skillvalue" class="skillvalue">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
            </select>
            <button class="sheet-skill-button" type="roll" value="&{template:lotfp_check} {{name=@{skillname}}} {{skillroll=[[1d6]]}} {{target=[[@{skillvalue}]]}}" name="Rollb_@{skillname}"></button>
        </fieldset>
    </div>
    <div class="sheet-col-right sheet-thick-border">
        <h3>Equipment</h3>
        <fieldset class="repeating_equipment">
             <input type="text" name="attr_itemname" class="sheet-bottom-line sheet-equipmentname">
             <select name="attr_encumbrance" class="encumbrance">
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="0">0</option>
              </select>
        </fieldset>
    </div>
</div>

<!-- SPELLS -->
<div class="sheet-thick-border sheet-spells">
    <h3>Spells</h3>
    <div class="sheet-spells-per-level">
      <span>Spells per level:</span>
      <div>
          <span>1: </span>
          <input type="number" name="attr_spells_l1" class="sheet-text-appearance" value="0">
          <span> / </span>
          <input type="number" name="attr_spells_l1_max" class="sheet-text-appearance" value="0">
      </div>
      <div>
          <span>2: </span>
          <input type="number" name="attr_spells_l2" class="sheet-text-appearance" value="0">
          <span> / </span>
          <input type="number" name="attr_spells_l2_max" class="sheet-text-appearance" value="0">
      </div>
      <div>
          <span>3: </span>
          <input type="number" name="attr_spells_l3" class="sheet-text-appearance" value="0">
          <span> / </span>
          <input type="number" name="attr_spells_l3_max" class="sheet-text-appearance" value="0">
      </div>
      <div>
          <span>4: </span>
          <input type="number" name="attr_spells_l4" class="sheet-text-appearance" value="0">
          <span> / </span>
          <input type="number" name="attr_spells_l4_max" class="sheet-text-appearance" value="0">
      </div>
      <div>
          <span>5: </span>
          <input type="number" name="attr_spells_l5" class="sheet-text-appearance" value="0">
          <span> / </span>
          <input type="number" name="attr_spells_l5_max" class="sheet-text-appearance" value="0">
      </div>
      <div>
          <span>6: </span>
          <input type="number" name="attr_spells_l6" class="sheet-text-appearance" value="0">
          <span> / </span>
          <input type="number" name="attr_spells_l6_max" class="sheet-text-appearance" value="0">
      </div>
      <div>
          <span>7: </span>
          <input type="number" name="attr_spells_l7" class="sheet-text-appearance" value="0">
          <span> / </span>
          <input type="number" name="attr_spells_l7_max" class="sheet-text-appearance" value="0">
      </div>
      <div>
          <span>8: </span>
          <input type="number" name="attr_spells_l8" class="sheet-text-appearance" value="0">
          <span> / </span>
          <input type="number" name="attr_spells_l8_max" class="sheet-text-appearance" value="0">
      </div>
      <div>
          <span>9: </span>
          <input type="number" name="attr_spells_l9" class="sheet-text-appearance" value="0">
          <span> / </span>
          <input type="number" name="attr_spells_l9_max" class="sheet-text-appearance" value="0">
      </div>
    </div>
    <fieldset class="repeating_spells">
        <input type="text" name="attr_spellname" class="sheet-bottom-line sheet-spellname" placeholder="Name">
        <select name="attr_spelltype" class="sheet-spelltype">
            <option value="Magic-User" selected>Magic-User</option>
            <option value="Cleric">Cleric</option>
        </select>
        <input type="text" name="attr_spelllevel" class="sheet-bottom-line sheet-spelllevel" placeholder="1">
        <input type="text" name="attr_spellduration" class="sheet-bottom-line sheet-spellduration" placeholder="Duration">
        <input type="text" name="attr_spellrange" class="sheet-bottom-line sheet-spellrange" placeholder="Range">
        <div>
            <span class="sheet-spellprepared-label"># prepared: </span>
            <input type="number" name="attr_spellprepared" class="sheet-bottom-line sheet-text-appearance sheet-spellprepared" value="0">
        </div>
        <button class="sheet-attack-button" type="roll" value="&{template:lotfp_check} {{name=@{spellname}}} {{spell=1}} {{charactername=@{name}}} {{type=@{spelltype}}} {{level=@{spelllevel}}} {{duration=@{spellduration}}} {{range=@{spellrange}}} {{description=@{spelldescription}}}" name="Roll"></button>
        <textarea spellcheck="false" name="attr_spelldescription" class="sheet-spelldescription sheet-bottom-line" placeholder="Description"></textarea>
    </fieldset>
</div>

<!-- Templates -->
<rolltemplate class="sheet-rolltemplate-lotfp_check">
    <table>
        {{#abilityroll}}
            <tr><th>{{name}} check</th></tr>
            <tr><td><span class="sheet-tcat">Roll: </span>{{abilityroll}}</td></tr>
        {{/abilityroll}}
        {{#attackroll}}
            <tr><th>{{charactername}} attacks with {{name}}</th></tr>
            <tr><td><span class="sheet-tcat">Attack Roll: </span>{{attackroll}}</td></tr>
            <tr><td><span class="sheet-tcat">Damage: </span>{{damageroll}}</td></tr>
        {{/attackroll}}
        {{#skillroll}}
            <tr><th>{{name}} check</th></tr>
            <tr><td><span class="sheet-tcat">Roll: </span>{{skillroll}} &lt;= {{target}} </td></tr>
            {{#rollLess() skillroll target}}
                    <tr><td class="sheet-subheader" style="color:green;"><b>Success!</b></td></tr>
            {{/rollLess() skillroll target}}
            {{#rollTotal() skillroll target}}
                    <tr><td class="sheet-subheader" style="color:green;"><b>Success!</b></td></tr>
            {{/rollTotal() skillroll target}}
            {{#rollGreater() skillroll target}}
                    <tr><td class="sheet-subheader" style="color:red;"><b>Failure.</b></td></tr>
            {{/rollGreater() skillroll target}}
        {{/skillroll}}
        {{#saveroll}}
            <tr><th>{{name}} save</th></tr>
            <tr><td><span class="sheet-tcat">Roll: </span>{{saveroll}} &gt; {{target}}</td></tr>
            {{#rollLess() saveroll target}}
                    <tr><td class="sheet-subheader" style="color:red;"><b>Failure.</b></td></tr>
            {{/rollLess() saveroll target}}
            {{#rollGreater() saveroll target}}
                    <tr><td class="sheet-subheader" style="color:green;"><b>Success!</b></td></tr>
            {{/rollGreater() saveroll target}}
        {{/saveroll}}
        {{#spell}}
            <tr><th>{{charactername}} casts {{name}}</th></tr>
            <tr class="sheet-spellrow"><td><span class="sheet-tcat">Level: </span>{{type}} {{level}}</td></tr>
            <tr class="sheet-spellrow"><td><span class="sheet-tcat">Duration: </span>{{duration}}</td></tr>
            <tr class="sheet-spellrow"><td><span class="sheet-tcat">Range: </span>{{range}}</td></tr>
            <tr class="sheet-spellrow"><td><span class="sheet-tcat">Description: </span>{{description}}</td></tr>
        {{/spell}}
    </table>
</rolltemplate>
<!-- Sheet workers -->
<script type="text/worker">
on('change:repeating_spells:spellprepared change:repeating_spells:spelllevel', () => {
	"use strict";
  getSectionIDs('repeating_spells', idArray => {
		const attrs = [
			...idArray.map(id => `repeating_spells_${id}_spelllevel`),
			...idArray.map(id => `repeating_spells_${id}_spellprepared`)
		];
		getAttrs(attrs, v => {
			const levels = ['1', '2', '3', '4', '5', '6', '7', '8', '9'],
				spellsPrepared = levels.reduce((m, level) => {
					m[`spells_l${level}`] = 0;
					return m;
				}, {});
			idArray.forEach(id => {
				if (levels.includes(v[`repeating_spells_${id}_spelllevel`])) {
					spellsPrepared['spells_l' + v[`repeating_spells_${id}_spelllevel`]] +=
						(parseInt(v[`repeating_spells_${id}_spellprepared`]) || 0);
				}
			});
			setAttrs(spellsPrepared);
		});
  });
});
</script>
