<!-- Top Row: Logo, Character info, Class & Level info -->
<div class="3colrow main">
    <div class="col">
        <img src="https://raw.githubusercontent.com/RandyKnapp/roll20-character-sheets/master/Zafir/zafir-black-small.png" />
    </div>

    <div class="col">
        <label>Name:</label><input type="text" spellcheck="false" name="attr_char_name" />
        <label>Pronouns:</label><input type="text" spellcheck="false" name="attr_char_pronouns" />
        <label>Origin:</label><input type="text" spellcheck="false" name="attr_char_origin" />
    </div>

    <div class="col">
        <label>Class:</label><input type="text" spellcheck="false" name="attr_class" />
        <label>Level:</label><input type="number" name="attr_level" /><br/>
        <label>XP:</label><input type="number" name="attr_xp" />
    </div>
</div>

<hr/>

<!-- Second Row: Base Attributes, Combat Attributes, Status -->
<div class="3colrow attributes">
    <div class="col">
        <h3>Base Attributes</h3>
        <label>Toughness:</label><input type="number" name="attr_toughness" /><br/>
        <label>Agility:</label><input type="number" name="attr_agility" /><br/>
        <label>Accuracy:</label><input type="number" name="attr_accuracy" /><br/>
        <label>Discipline:</label><input type="number" name="attr_discipline" />
    </div>

    <div class="col">
        <h3>Combat Attributes</h3>
        <label class="tooltip">Max HP:<span class="tooltiptext"><b>Max HP:</b><br/>2<br/>+&nbsp;Half&nbsp;Level<br/>+&nbsp;Toughness<br/>+&nbsp;Body&nbsp;Armor<br/>+&nbsp;Other</span></label><input type="number" name="attr_hp_max" /><br/>
        <label class="tooltip">Speed:<span class="tooltiptext"><b>Speed:</b><br/>6<br/>+&nbsp;Double&nbsp;Agility<br/>+&nbsp;Equipment<br/>+&nbsp;Abilities<br/>+&nbsp;Other</span></label><input type="number" name="attr_speed" /><br/>
        <label class="tooltip">Aim:<span class="tooltiptext"><b>Aim:</b><br/>Accuracy<br/>+&nbsp;Equipment<br/>+&nbsp;Abilities<br/>+&nbsp;Other</span></label><input type="number" name="attr_aim" /><br/>
        <label class="tooltip">Will:<span class="tooltiptext"><b>Will:</b><br/>Discipline<br/>+&nbsp;Equipment<br/>+&nbsp;Abilities<br/>+&nbsp;Other</span></label><input type="number" name="attr_will" />
    </div>

    <div class="col">
        <h3>Status</h3>
        <label>HP <span style="font-family:Pictos">k</span>:</label><input type="number" name="attr_hp" /><span class="labellike">&nbsp;/&nbsp;</span><span class="labellike" name="attr_hp_max"></span><br/>
        <label>AP <span style="font-family:'Pictos Three'">b</span>:</label><input type="number" name="attr_ap" /><br/>
        <label>SP <span style="font-family:Pictos">L</span>:</label><input type="number" name="attr_sp" /><br/>
        <label>Focus:</label><input type="number" name="attr_focus" />
    </div>
</div>


<!-- Main tab bar -->
<br />
<input type="hidden" class="tabstoggle" name="attr_sheetTab" value="atk" />
<div class="tabrow">
    <button type="action" name="act_atk" class="atkbtn">Combat Panel</button>
    <button type="action" name="act_aab" class="aabbtn">Abilities</button>
    <button type="action" name="act_eqp" class="eqpbtn">Equipment</button>
    <button type="action" name="act_res" class="resbtn">Responsibilities</button>
    <button type="action" name="act_inv" class="invbtn">Inventory</button>
    <button type="action" name="act_oth" class="othbtn">Misc</button>
</div>
<br />

<!-- Combat Tracker -->
<div class="atk">
    <button type="action" name="act_roundstart" class="btn">Round Start</button>
    <button type="action" name="act_initcombat" class="btn">Initialize Combat</button>
    <h2>Combat Panel</h2>
    <div class="2colrow">
        <div class="col1 nowrap">
            <h3>Weapon Attacks</h3>
            <label>Target Cover:</label><select name="attr_atkcover">
                <option value="Full Cover">Full Cover (+0)</option>
                <option value="Half Cover">Half Cover (+1 aim)</option>
                <option value="No Cover">No Cover (+2 aim/+2 crit)</option>
            </select><br />
            <label>Elevation:</label><select name="attr_atkelevation">
                <option value="None">None (+0)</option>
                <option value="Elevation">Elevation (+1 aim)</option>
            </select><br />
            <label>Range:</label><select name="attr_atkrange">
                <option value="Optimal Range">Optimal Range (+0)</option>
                <option value="Non-optimal">Too Close/Too Far (-1 aim)</option>
            </select><br />
            <label>Bonus Aim:</label><input style="width:18%;position:relative;right:3px;margin-right:93px;" type="number" value="0" name="attr_atkotheraim" />
            <label>Bonus Crit:</label><input style="width:18%;position:relative;right:3px;" type="number" value="0" name="attr_atkothercrit" />
            <div class="attack clearfix">
                <button type="roll" name="roll_attackprimary" class="btn" value="&{template:zafir} {{name=@{wpname} Attack}} {{aim=[[(@{wpattackaimdice})d6>5]]}} {{crit=[[(@{wpattackcritdice})d6>6]]}} {{damage=[[(@{wpattackdamage})]]}} {{critdmg=[[(@{wpattackdamage}) + (@{wpcritdmg})]]}}">Attack</button>
                <label style="width:130px"><span name="attr_wpname"></span></label>
                    <label>+<span name="attr_wpattackaimdice"></span> aim&nbsp;&nbsp;&nbsp;+<span name="attr_wpattackcritdice"></span> crit&nbsp;&nbsp;&nbsp;damage: <span name="attr_wpattackdamage"></span></label>
            </div>
            <div class="attack clearfix">
                <button type="roll" name="roll_attacksecondary" class="btn" value="&{template:zafir} {{name=@{wsname} Attack}} {{aim=[[(@{wsattackaimdice})d6>5]]}} {{crit=[[(@{wsattackcritdice})d6>6]]}} {{damage=[[(@{wsattackdamage})]]}} {{critdmg=[[(@{wsattackdamage}) + (@{wscritdmg})]]}}">Attack</button>
                <label style="width:130px"><span name="attr_wsname"></span></label>
                    <label>+<span name="attr_wsattackaimdice"></span> aim&nbsp;&nbsp;&nbsp;+<span name="attr_wsattackcritdice"></span> crit&nbsp;&nbsp;&nbsp;damage: <span name="attr_wsattackdamage"></span></label>
            </div>
            <div class="attack clearfix">
                <button type="roll" name="roll_attackcustom" class="btn" value="&{template:zafir} {{name=Custom Attack}} {{aim=[[(@{custattackaimdice})d6>5]]}} {{crit=[[(@{custattackcritdice})d6>6]]}} {{damage=[[(@{custattackdamage})]]}} {{critdmg=[[(@{custattackdamage})]]}}">Attack</button>
                <label style="width:130px;font-style:italic;">Custom</label>
                    <label>+<span name="attr_custattackaimdice"></span> aim&nbsp;&nbsp;&nbsp;+<span name="attr_custattackcritdice"></span> crit&nbsp;&nbsp;&nbsp;damage: <input type="text" name="attr_custattackdamage" spellcheck="false"></span></label>
            </div>
            <hr />
            <h3>Will Attack</h3>
        </div>
        <div class="col2">
            <h3>Ammo Tracker</h3>
            <div class="ammotrack clearfix">
                <button type="action" name="act_reloadprimary" class="btn">Reload</button>
                <label style="width:110px"><span name="attr_wpname" value="<primary weapon>"></span>:</label><input type="number" name="attr_wpammo" /><span class="labellike">&nbsp;/&nbsp;</span><span class="labellike" name="attr_wpammo_max"></span><br/>
            </div>
            <h3 style="margin-top:12px;">Cooldown Tracker</h3>
            <div class="inset nowrap tracker">
                <fieldset class="repeating_cooldowntracker">
                    <input style="width:80%" type="text" spellcheck="false" name="attr_cooldownname" />
                    <input style="width:18%" type="number" name="attr_cooldownvalue" />
                </fieldset>
            </div>
            <h3 style="margin-top:12px;">Charges Tracker</h3>
            <div class="inset nowrap tracker">
                <fieldset class="repeating_chargetracker">
                    <input style="width:80%" type="text" spellcheck="false" name="attr_chargename" />
                    <input style="width:18%" type="number" name="attr_chargevalue" />
                </fieldset>
            </div>
        </div>
    </div>
</div>

<!-- Abilities -->
<div class="aab">
    <input type="hidden" class="tabstoggle" name="attr_sheetTabAbilities" value="aaa" />
    <div class="tabrow">
        <h2>Abilities</h2>
        <button type="action" name="act_aaa" class="aaabtn">Active Abilities</button>
        <button type="action" name="act_apa" class="apabtn">Passive Abilities</button>
    </div>
    <br />

    <div class="aaa nowrap">
        <h3>Active Abilities</h3>
        <fieldset class="repeating_activeabilities">
            <label>Name:</label><input type="text" spellcheck="false" name="attr_aablname" />
            <label>Activation:</label>
                <select name="attr_aablactivation">
                    <option value="Free Action">Free Action</option>
                    <option value="Action">Action</option>
                    <option value="Action + Ends Turn">Action + Ends Turn</option>
                </select>
                <br/>
            <div class="3colrow">
                <div class="col">
                    <label>Range:</label>
                    <select name="attr_aablrange">
                        <option value="Self">Self</option>
                        <option value="Weapon">Weapon</option>
                        <option value="Adjacent">Adjacent</option>
                        <option value="Short">Short</option>
                        <option value="Medium">Medium</option>
                        <option value="Long">Long</option>
                        <option value="-">-</option>
                    </select>
                </div>
                <div class="col">
                    <label>Cooldown:</label><input type="number" name="attr_aablcooldown" />
                </div>
                <div class="col">
                    <label>Charges:</label><input type="number" name="attr_aablcharges" /><br/>
                </div>
            </div>
            <label>Effect:</label><textarea name="attr_aableffect"></textarea>
            <hr />
        </fieldset>
    </div>
    <div class="apa">
        <h3>Passive Abilities</h3>
        <fieldset class="repeating_passiveabilities">
            <label>Name:</label><input type="text" spellcheck="false" name="attr_pablname" /><br/>
            <label>Effect:</label><textarea name="attr_pableffect"></textarea>
            <hr />
        </fieldset>
    </div>
</div>

<!-- Equipment -->
<div class="eqp">
    <input type="hidden" class="tabstoggle" name="attr_sheetTabEqp" value="epw" />
    <div class="tabrow">
        <h2>Equipment</h2>
        <button type="action" name="act_epw" class="epwbtn">Primary Weapon</button>
        <button type="action" name="act_esw" class="eswbtn">Secondary Weapon</button>
        <button type="action" name="act_eba" class="ebabtn">Body Armor</button>
        <button type="action" name="act_ehg" class="ehgbtn">Headgear</button>
    </div>
    <br />
    <div class="epw">
        <h3>Primary Weapon</h3>
        <div class="2colrow">
            <div class="col nowrap">
                <label>Name:</label><input type="text" spellcheck="false" name="attr_wpname" /><br/>
                <label>Range:</label>
                    <select name="attr_wprange">
                        <option value="Adjacent">Adjacent</option>
                        <option value="Short">Short</option>
                        <option value="Medium">Medium</option>
                        <option value="Long">Long</option>
                    </select>
                    <br/>
                <div class="2colrowx">
                    <div class="colx">
                        <label>Aim Dice:</label><input type="number" name="attr_wpaimdice" />
                    </div>
                    <div class="colx">
                        <label>Crit Dice:</label><input type="number" name="attr_wpcritdice" />
                    </div>
                </div>
                <label>Damage:</label><input type="text" spellcheck="false" name="attr_wpdamage" /><br/>
                <div class="2colrowx">
                    <div class="colx">
                        <label>Crit Dmg:</label><input type="number" name="attr_wpcritdmg" />
                    </div>
                    <div class="colx">
                        <label>Max Ammo:</label><input type="number" name="attr_wpammo_max" />
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="clearfix">
                    <label>Notes:</label><textarea name="attr_wpnotes"></textarea>
                </div>
                <label>Mod Slots:</label><input type="number" name="attr_wp_modslots" /><br/>
                <div class="clearfix">
                    <label>Mods:</label><textarea name="attr_wpmods"></textarea>
                </div>
            </div>
        </div>
    </div>
    <div class="esw">
        <h3>Secondary Weapon</h3>
        <div class="2colrow">
            <div class="col nowrap">
                <label>Name:</label><input type="text" spellcheck="false" name="attr_wsname" /><br/>
                <label>Range:</label>
                    <select name="attr_wsrange">
                        <option value="Adjacent">Adjacent</option>
                        <option value="Short">Short</option>
                        <option value="Medium">Medium</option>
                        <option value="Long">Long</option>
                    </select>
                    <br/>
                <div class="2colrowx">
                    <div class="colx">
                        <label>Aim Dice:</label><input type="number" name="attr_wsaimdice" />
                    </div>
                    <div class="colx">
                        <label>Crit Dice:</label><input type="number" name="attr_wscritdice" />
                    </div>
                </div>
                <label>Damage:</label><input type="text" spellcheck="false" name="attr_wsdamage" /><br/>
                <div class="2colrowx">
                    <div class="colx">
                        <label>Crit Dmg:</label><input type="number" name="attr_wscritdmg" />
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="clearfix">
                    <label>Notes:</label><textarea name="attr_wsnotes"></textarea>
                </div>
                <label>Mod Slots:</label><input type="number" name="attr_ws_modslots" /><br/>
                <div class="clearfix">
                    <label>Mods:</label><textarea name="attr_wsmods"></textarea>
                </div>
            </div>
        </div>
    </div>
    <div class="eba">
        <h3>BodyArmor</h3>
        <div class="2colrow">
            <div class="col">
                <label>Name:</label><input type="text" spellcheck="false" name="attr_baname" /><br/>
                <div class="3colrowx nowrap">
                    <div class="colx">
                        <label>HP:</label><input type="number" name="attr_bahp" />
                    </div>
                    <div class="colx">
                        <label style="position:relative;left:50px;">AP:</label><input type="number" name="attr_baap" />
                    </div>
                    <div class="colx">
                        <label style="position:relative;left:50px;">SP:</label><input type="number" name="attr_basp" />
                    </div>
                </div>
                <div class="clearfix">
                    <label>Notes:</label><textarea name="attr_banotes"></textarea>
                </div>
                <label>Mod Slots:</label><input type="number" name="attr_ba_modslots" /><br/>
                <div class="clearfix">
                    <label>Mods:</label><textarea name="attr_bamods"></textarea>
                </div>
            </div>
            <div class="col pockets">
                <span class="labellike help tooltip">&nbsp;<span style="font-family:Pictos">?</span><span class="tooltiptext"><b>Empty Pockets:</b><br/>To get an empty pocket to stay on the character sheet, put a dash (-) in the text field.</span></span> 
                <h3>Pockets</h3>
                <fieldset class="repeating_bapockets">
                    <select name="attr_pocketname">
                        <option value="Utility">Utility</option>
                        <option value="Grenade">Grenade</option>
                        <option value="Special Ammo">Special Ammo</option>
                        <option value="Hardpoint">Hardpoint</option>
                    </select>
                    <input type="text" spellcheck="false" name="attr_pocketitemname" />
                </fieldset>
            </div>
        </div>
    </div>
    <div class="ehg">
        <h3>Headgear</h3>
        <div class="2colrow">
            <div class="col">
                <label>Name:</label><input type="text" spellcheck="false" name="attr_hgname" /><br/>
                <div class="clearfix">
                    <label>Effects:</label><textarea name="attr_hgeffects"></textarea>
                </div>
            </div>
            <div class="col">
            </div>
        </div>
    </div>
</div>

<!-- Responsibilities -->
<div class="res">
    <h2>Responsibilities</h2>
    <div class="3colrow">
        <div class="col">
            <label>Acquisition:</label><input type="number" name="attr_acquisition" /><br/>
            <label>Arcana:</label><input type="number" name="attr_arcana" /><br/>
            <label>Engineering:</label><input type="number" name="attr_engineering" /><br/>
            <label>Entertainment:</label><input type="number" name="attr_entertainment" /><br/>
            <label>Leadership:</label><input type="number" name="attr_leadership" />
        </div>
        <div class="col">
            <label>Medicine:</label><input type="number" name="attr_medicine" /><br/>
            <label>Navigation:</label><input type="number" name="attr_navigation" /><br/>
            <label>Security:</label><input type="number" name="attr_security" /><br/>
            <label>Spirituality:</label><input type="number" name="attr_spirituality" /><br/>
            <label>Sustenance:</label><input type="number" name="attr_sustenance" />
        </div>
        <div class="col">
        </div>
    </div>
</div>

<!-- Inventory -->
<div class="inv">
    <div class="3colrow">
        <div class="col">
            <h2>Money</h2>
            <label class="short money" style="font-family:Helvetica, Arial">₹</label><input type="number" class="expand" name="attr_money" /><br/>
        </div>
        <div class="col">
            <h2>Inventory</h2>
            <fieldset class="repeating_inv">
                <input type="text" class="full" spellcheck="false" name="attr_invitemname" />
            </fieldset>
        </div>
        <div class="col">
        </div>
    </div> 
</div>

<!-- Misc -->
<div class="oth">
    <div class="3colrow">
        <div class="col">
            <h2>Proficiencies</h2>
            <div class="inset">
                <fieldset class="repeating_proficiencies">
                    <input type="text" class="full" spellcheck="false" name="attr_proficiencyname" />
                </fieldset>
            </div>
        </div>
        <div class="col">
            <h2>Languages</h2>
            <h3>Fluent</h3>
            <div class="inset">
                <fieldset class="repeating_fluentlangs">
                    <input type="text" class="full" spellcheck="false" name="attr_flangname" />
                </fieldset>
            </div>
            <br />
            <h3>Conversational</h3>
            <div class="inset">
                <fieldset class="repeating_convlangs">
                    <input type="text" class="full" spellcheck="false" name="attr_clangname" />
                </fieldset>
            </div>
        </div>
        <div class="col">
        </div>
    </div>
</div>

<!-- // Roll Templates //////////////////////////////////////////////////////////////// -->
<rolltemplate class="sheet-rolltemplate-zafir">
    <div class="sheet-template-container">
        <div class="sheet-template-header">{{name}}</div>
        {{#rollGreater() aim 0}}
            {{#rollGreater() crit 0}}
                <div class="sheet-template-row">CRITICAL HIT! {{aim}} {{crit}}</div>
                <div class="sheet-template-row">Critical Damage: {{critdmg}}</div>
            {{/rollGreater() crit 0}}
            {{#rollTotal() crit 0}}
                <div class="sheet-template-row">HIT! {{aim}}</div>
                <div class="sheet-template-row">Damage: {{damage}}</div>
            {{/rollTotal() crit 0}}
        {{/rollGreater() aim 0}}
        {{#rollTotal() aim 0}}
            <div class="sheet-template-row">MISS! {{aim}}</div>
        {{/rollTotal() aim 0}}
    </div>
</rolltemplate>

<!-- // Sheet Workers //////////////////////////////////////////////////////////////// -->
<script type="text/worker">
// Main tab bar
const buttonlist = ["atk", "aab", "pab", "eqp", "res", "inv", "oth"];
buttonlist.forEach(button => {
    on(`clicked:${button}`, function() {
        setAttrs({
            sheetTab: button
        });
    });
});

// Equipment sheet tab bar
const buttonlistEqp = ["epw", "esw", "eba", "ehg"];
buttonlistEqp.forEach(button => {
    on(`clicked:${button}`, function() {
        setAttrs({
            sheetTabEqp: button
        });
    });
});

// Equipment sheet tab bar
const buttonlistAbilities = ["aaa", "apa"];
buttonlistAbilities.forEach(button => {
    on(`clicked:${button}`, function() {
        setAttrs({
            sheetTabAbilities: button
        });
    });
});

function sheetOpenAndAttrChanged(inputs) {
    return "sheet:opened change:" + inputs.join(" change:");
}

// Setting the aim dice for weapon attacks
const inputs = ["wpaimdice", "wpcritdice", "wpdamage", "wsaimdice", "wscritdice", "wsdamage", "aim", "atkcover", "atkelevation", "atkrange", "atkotheraim", "atkothercrit" ];
on(sheetOpenAndAttrChanged(inputs), function() {
    getAttrs(inputs, function(values) {
        let wpaimdice = parseInt(values.wpaimdice)||0;
        let wpcritdice = parseInt(values.wpcritdice)||0;
        let wpdamage = values.wpdamage;
        let wsaimdice = parseInt(values.wsaimdice)||0;
        let wscritdice = parseInt(values.wscritdice)||0;
        let wsdamage = values.wsdamage;
        let aim = parseInt(values.aim)||0;
        let atkcover = values.atkcover;
        let atkelevation = values.atkelevation;
        let atkrange = values.atkrange;
        let atkotheraim = parseInt(values.atkotheraim)||0;
        let atkothercrit = parseInt(values.atkothercrit)||0;

        let aimBonus = 0;
        let critBonus = 0;

        // Cover
        if (atkcover == "No Cover") {
            aimBonus += 2;
            critBonus += 2;
        }
        else if (atkcover == "Half Cover") {
            aimBonus += 1;
        }

        // Elevation
        if (atkelevation == "Elevation") {
            aimBonus += 1;
        }

        // Range
        if (atkrange == "Non-optimal") {
            aimBonus -= 1;
        }

        setAttrs({
            wpattackaimdice: Math.max(wpaimdice + aim + atkotheraim + aimBonus, 0),
            wpattackcritdice: Math.max(wpcritdice + atkothercrit + critBonus, 0),
            wpattackdamage: wpdamage,
            wsattackaimdice: Math.max(wsaimdice + aim + atkotheraim + aimBonus, 0),
            wsattackcritdice: Math.max(wscritdice + atkothercrit + critBonus, 0),
            wsattackdamage: wsdamage,
            custattackaimdice: Math.max(aim + atkotheraim + aimBonus, 0),
            custattackcritdice: Math.max(atkothercrit + critBonus, 0)
        });
    });
});

on("clicked:initcombat", function() {
    console.log("initcombat");
});

on("clicked:roundstart", function() {
    alert("roundstart");
});

on("clicked:attackprimary", function() {
    console.log("attackprimary");
});

on("clicked:attacksecondary", function() {
    console.log("attacksecondary");
});

on("clicked:attackcustom", function() {
    console.log("attackcustom");
});

on("clicked:reloadprimary", function() {
    getAttrs(["wpammo_max"], function(values) {
        let wpammo_max = parseInt(values.wpammo_max)||0;
        setAttrs({
            wpammo: wpammo_max
        });
    });
});

</script>
