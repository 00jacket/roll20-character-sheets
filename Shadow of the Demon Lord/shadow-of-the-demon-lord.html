<!-- Global settings -->
<input type="checkbox" name="attr_setting_show_core_spinners" class="sheet-hidden sheet-show-core-spinners" value="1">
<input type="checkbox" name="attr_setting_basic_equipment" class="sheet-hidden sheet-basic-equipment" value="1">
<input type="checkbox" name="attr_setting_versus_freeform" class="sheet-hidden sheet-versus-freeform" value="1">

<!-- Tab radios -->
<div class="sheet-title">
	<input type="checkbox" name="attr_npc" class="sheet-hidden sheet-npc-toggle" value="1">
	<label class="sheet-tab-selector" title="Main" data-i18n-title="MAIN">
		<input type="radio" name="attr_tab" value="main" checked><span data-i18n="MAIN">Main</span>
	</label>
	<label class="sheet-tab-selector" title="NPC" data-i18n-title="NPC">
		<input type="radio" name="attr_tab" value="npc" checked><span data-i18n="NPC">NPC</span>
	</label>
	<label class="sheet-tab-selector" title="Equipment/Talents" data-i18n-title="EQUIPMENT_TALENTS">
		<input type="radio" name="attr_tab" value="equipment_talents"><span><span class="sheet-equipment-label"><span data-i18n="EQUIPMENT">Equipment</span> / </span><span data-i18n="TALENTS">Talents</span></span>
	</label>
	<label class="sheet-tab-selector" title="Spells" data-i18n-title="SPELLS">
		<input type="radio" name="attr_tab" value="spells"><span data-i18n="SPELLS">Spells</span>
	</label>
	<label class="sheet-tab-selector" title="Background" data-i18n-title="BACKGROUND">
		<input type="radio" name="attr_tab" value="background"><span data-i18n="BACKGROUND">Background</span>
	</label>
	<label class="sheet-edit-button">
		<input type="checkbox" name="attr_edit_mode" checked>
		<span>p</span>
	</label>
	<label class="sheet-settings-checkbox" title="Settings" data-i18n-title="SETTINGS">
		<input type="checkbox" name="attr_show_settings" value="1">
		<span>y</span>
	</label>
</div>

<!-- Settings -->
<input type="checkbox" name="attr_show_settings" class="sheet-hidden sheet-hider" value="1">
<div class="sheet-settings">
	<input type="hidden" name="attr_boons_banes_query" value="?{#(Boons - Banes)|0}">
	<label>
		<input type="checkbox" name="attr_npc" value="1">
		<span data-i18n="NPC?">NPC?</span>
	</label>
	<label>
		<select name="attr_output_option">
			<option value="" data-i18n="PUBLIC">Public</option>
			<option value="/w GM" data-i18n="WHISPERED_TO_GM">Whispered to GM</option>
			<option value="@{whisper_query}" data-i18n="QUERY">Query</option>
		</select>
		<input type="hidden" name="attr_whisper_query" value="?{Output|Public, |Whispered to GM,/w GM}">
		<span data-i18n="SHEET_OUTPUT">Sheet output</span>
	</label>
	<label>
		<input type="checkbox" name="attr_setting_auto_spell_castings" value="1" checked>
		<span data-i18n="AUTO_SPELL_CASTINGS">Automatically calculate maximum spell castings based on spell rank and power</span>
		<input type="checkbox" name="attr_setting_spell_expertise" value="0">
		<span data-i18n="SPELL_EXPERTISE">Spell expertise (Wizard)</span>
	</label>
	<label>
		<input type="number" name="attr_global_attack_boons" value="0">
		<span data-i18n="GLOBAL_ATTACK_BOONS_BANES">(Boons - Banes) to all attack rolls</span>
	</label>
	<label>
		<input type="number" name="attr_global_weapon_attack_boons" value="0">
		<span data-i18n="GLOBAL_WEAPON_ATTACK_BOONS_BANES">(Boons - Banes) to all weapon attack rolls</span>
	</label>
	<label>
		<input type="number" name="attr_global_spell_attack_boons" value="0">
		<span data-i18n="GLOBAL_SPELL_ATTACK_BOONS_BANES">(Boons - Banes) to all spell attack rolls</span>
	</label>
	<label>
		<input type="number" name="attr_global_challenge_boons" value="0">
		<span data-i18n="GLOBAL_CHALLENGE_BOONS_BANES">(Boons - Banes) to all challenge rolls</span>
	</label>
	<label>
		<input type="text" spellcheck="false" name="attr_global_damage_bonus" value="0">
		<span data-i18n="GLOBAL_WEAPON_DAMAGE_BONUS">Bonus to all weapon damage</span>
	</label>
	<label>
		<span data-i18n="HEALING_RATE">Healing Rate</span>
		<span>=</span>
		<span data-i18n="HEALTH">Health</span>
		<span>/</span>
		<input type="number" name="attr_setting_healing_rate_divisor" value="4">
	</label>
	<label>
		<input type="checkbox" name="attr_setting_show_core_spinners" value="1">
		<span data-i18n="SHOW_UP_DOWN_CHARACTERISTICS">Show up/down arrows on characteristics</span>
	</label>
	<label>
		<input type="checkbox" name="attr_setting_versus_freeform" value="1">
		<span data-i18n="SHOW_VERSUS_TEXT">Show a text field instead of dropdown for "Against" fields</span>
	</label>
	<label>
		<input type="checkbox" name="attr_setting_basic_equipment" value="1">
		<span data-i18n="BASIC_EQUIPMENT">Basic equipment</span>:
		<span data-i18n="BASIC_EQUIPMENT_INFO">Show only textarea, hide detailed equipment column</span>
	</label>
	<label>
		<input type="text" spellcheck="false" name="attr_die_attack" value="1d20">
		<span data-i18n="DIE_ATTACK">Die type for attack rolls</span>
	</label>
	<label>
		<input type="text" spellcheck="false" name="attr_die_challenge" value="1d20">
		<span data-i18n="DIE_CHALLENGE">Die type for challenge rolls</span>
	</label>
	<label>
		<input type="text" spellcheck="false" name="attr_die_boon" value="d6">
		<span data-i18n="DICE_BOONS">Dice to use for boons and banes</span>
	</label>
</div>

<!-- Main -->
<input type="checkbox" name="attr_tab" class="sheet-hidden sheet-tab" value="main" checked>
<div class="sheet-main sheet-pane">
	<div class="sheet-row-1">
		<div class="sheet-left-col">
			<label>
				<div data-i18n="NAME">Name</div>
				<input type="text" spellcheck="false" name="attr_name">
			</label>
			<label>
				<div data-i18n="DESCRIPTION">Description</div>
				<textarea spellcheck="false" name="attr_description"></textarea>
			</label>
		</div>
		<div class="sheet-middle-col">
			<div class="sheet-box">
				<label class="sheet-ancestry">
					<div data-i18n="ANCESTRY">Ancestry</div>
					<input type="text" spellcheck="false" name="attr_ancestry">
				</label>
				<label>
					<div data-i18n="NOVICE">Novice</div>
					<input type="text" spellcheck="false" name="attr_novice">
				</label>
				<label>
					<div data-i18n="EXPERT">Expert</div>
					<input type="text" spellcheck="false" name="attr_expert">
				</label>
				<label>
					<div data-i18n="MASTER">Master</div>
					<input type="text" spellcheck="false" name="attr_master">
				</label>
				<label class="sheet-encircled sheet-lvl">
					<span data-i18n="LEVEL">Level</span>
					<input type="number" name="attr_level" min="0" value="0">
				</label>
			</div>
		</div>
		<div class="sheet-right-col">
			<label>
				<div data-i18n="RELIGION">Religion</div>
				<input type="text" spellcheck="false" name="attr_religion">
			</label>
			<label>
				<div data-i18n="LANGUAGES">Languages</div>
				<input type="text" spellcheck="false" name="attr_languages">
			</label>
			<label>
				<div data-i18n="PROFESSIONS">Professions</div>
				<textarea spellcheck="false" name="attr_professions"></textarea>
			</label>
		</div>
	</div>
	<div class="sheet-row-2">
		<div class="sheet-left-col">
			<label>
				<div data-i18n="NOTES_ETC">Notes/MoDs/Quirks/etc</div>
				<textarea spellcheck="false" name="attr_notes"></textarea>
			</label>
		</div>
		<div class="sheet-attr-box">
			<input type="hidden" name="attr_strength_mod" value="+0">
			<input type="hidden" name="attr_agility_mod" value="+0">
			<input type="hidden" name="attr_intellect_mod" value="+0">
			<input type="hidden" name="attr_perception_mod" value="+0">
			<input type="hidden" name="attr_will_mod" value="+0">
			<label class="sheet-encircled sheet-strength">
				<span data-i18n="STRENGTH">Strength</span>
				<input type="number" class="sheet-lg" name="attr_strength" min="0" value="10">
			</label>
			<span class="sheet-mod sheet-no-spinners" name="attr_strength_mod">+0</span>
			<button type="roll" name="roll_Strength" value="@{output_option} &{template:sotdl} {{name=@{name}}} {{title=^{STRENGTH}}} {{roll=[[@{die_challenge} + (@{strength_mod}) + [[@{boons_banes_query} + @{global_challenge_boons} - @{banes_from_afflictions}]]@{die_boon}k1[boons/banes]]]}}">
			</button>
			<label class="sheet-encircled sheet-size">
				<span data-i18n="SIZE">Size</span>
				<input type="text" spellcheck="false" name="attr_size" value="1">
			</label>
		</div>
		<div class="sheet-attr-box">
			<label class="sheet-encircled sheet-intellect">
				<span data-i18n="INTELLECT">Intellect</span>
				<input type="number" class="sheet-lg" name="attr_intellect" min="0" value="10">
			</label>
			<span class="sheet-mod sheet-no-spinners" name="attr_intellect_mod">+0</span>
			<button type="roll" name="roll_Intellect" value="@{output_option} &{template:sotdl} {{name=@{name}}} {{title=^{INTELLECT}}} {{roll=[[@{die_challenge} + (@{intellect_mod}) + [[@{boons_banes_query} + @{global_challenge_boons} - @{banes_from_afflictions}]]@{die_boon}k1[boons/banes]]]}}">
			</button>
			<label class="sheet-encircled sheet-perception">
				<span data-i18n="PERCEPTION">Perception</span>
				<input type="number" name="attr_perception" min="0" value="10">
			</label>
			<span class="sheet-mod sheet-no-spinners" name="attr_perception_mod">+0</span>
			<button type="roll" name="roll_Perception" value="@{output_option} &{template:sotdl} {{name=@{name}}} {{title=^{PERCEPTION}}} {{roll=[[@{die_challenge} + (@{perception_mod}) + [[@{boons_banes_query} + @{global_challenge_boons} - @{banes_from_afflictions}]]@{die_boon}k1[boons/banes]]]}}">
			</button>
		</div>
		<div class="sheet-attr-box">
			<label class="sheet-encircled sheet-agility">
				<span data-i18n="AGILITY">Agility</span>
				<input type="number" class="sheet-lg" name="attr_agility" min="0" value="10">
			</label>
			<span class="sheet-mod sheet-no-spinners" name="attr_agility_mod">+0</span>
			<button type="roll" name="roll_Agility" value="@{output_option} &{template:sotdl} {{name=@{name}}} {{title=^{AGILITY}}} {{roll=[[@{die_challenge} + (@{agility_mod}) + [[@{boons_banes_query} + @{global_challenge_boons} - @{banes_from_afflictions}]]@{die_boon}k1[boons/banes]]]}}">
			</button>
			<label class="sheet-encircled sheet-speed">
				<span data-i18n="SPEED">Speed</span>
				<input type="number" name="attr_speed" min="0" value="10">
			</label>
		</div>
		<div class="sheet-attr-box">
			<label class="sheet-encircled sheet-will">
				<span data-i18n="WILL">Will</span>
				<input type="number" class="sheet-lg" name="attr_will" min="0" value="10">
			</label>
			<span class="sheet-mod sheet-no-spinners" name="attr_will_mod">+0</span>
			<button type="roll" name="roll_Will" value="@{output_option} &{template:sotdl} {{name=@{name}}} {{title=^{WILL}}} {{roll=[[@{die_challenge} + (@{will_mod}) + [[@{boons_banes_query} + @{global_challenge_boons} - @{banes_from_afflictions}]]@{die_boon}k1[boons/banes]]]}}">
			</button>
			<label class="sheet-encircled sheet-insanity">
				<span data-i18n="INSANITY">Insanity</span>
				<input type="number" name="attr_insanity" min="0" value="0">
			</label>
		</div>
		<div class="sheet-attr-box">
			<label class="sheet-encircled sheet-health">
				<span data-i18n="HEALTH">Health</span>
				<input type="number" class="sheet-lg" name="attr_health" min="0" value="10">
			</label>
			<label class="sheet-encircled sheet-healing-rate">
				<span data-i18n="HEALING_RATE">Healing Rate</span>
				<input type="number" name="attr_healing_rate" class="sheet-no-spinners" value="2" readonly>
			</label>
			<label class="sheet-encircled sheet-defense">
				<span data-i18n="DEFENSE">Defense</span>
				<input type="number" name="attr_defense" min="0" value="10">
			</label>
			<label class="sheet-encircled sheet-corruption">
				<span data-i18n="CORRUPTION">Corruption</span>
				<input type="number" name="attr_corruption" min="0" value="0">
			</label>
		</div>
		<div class="sheet-attr-box">
			<label class="sheet-encircled sheet-power">
				<span data-i18n="POWER">Power</span>
				<input type="number" name="attr_power" min="0" value="0">
			</label>
			<label class="sheet-encircled sheet-damage">
				<span data-i18n="DAMAGE">Damage</span>
				<input type="number" class="sheet-lg" name="attr_damage" min="0" value="0">
			</label>
			<label class="sheet-damage-max">
				<span><span data-i18n="MAX">Max</span>:</span>
				<span name="attr_damage_max">10</span>
			</label>
		</div>
		<div class="sheet-middle-col">
			<div>
				<span data-i18n="AFFLICTIONS">Afflictions</span>
				<input type="hidden" name="attr_banes_from_afflictions" value="0">
				(<span name="attr_banes_from_afflictions"></span>
				<span class="sheet-lower" data-i18n="BANES">banes</span>)
			</div>
			<div class="sheet-afflictions-bg">
				<label>
					<input type="checkbox" name="attr_affliction_asleep" value="1">
					<span data-i18n="ASLEEP">Asleep</span>
					<div data-i18n="ASLEEP_DESC">Becomes prone and unconscious. Action to wake up. Removed upon taking damage unless noted otherwise.</div>
				</label>
				<label>
					<input type="checkbox" name="attr_affliction_blinded" value="1">
					<span data-i18n="BLINDED">Blinded</span>
					<div data-i18n="BLINDED_DESC">Cannot see: surroundings obscured, sight-based Perception fails. Attack rolls against Defense or Agility get 1 boon. Speed becomes 2 unless lower.</div>
				</label>
				<label>
					<input type="checkbox" name="attr_affliction_charmed" value="1">
					<span data-i18n="CHARMED">Charmed</span>
					<div data-i18n="CHARMED_DESC">Treats source as trusted friend and ally. Cannot attack source.</div>
				</label>
				<label>
					<input type="checkbox" name="attr_affliction_compelled" value="1">
					<span data-i18n="COMPELLED">Compelled</span>
					<div data-i18n="COMPELLED_DESC">Cannot use actions or move. Instead, source can force creature to move or use an action during fast turn. All decisions are made by source.</div>
				</label>
				<label>
					<input type="checkbox" name="attr_affliction_dazed" value="1">
					<span data-i18n="DAZED">Dazed</span>
					<div data-i18n="DAZED_DESC">Cannot use actions.</div>
				</label>
				<label>
					<input type="checkbox" name="attr_affliction_deafened" value="1">
					<span data-i18n="DEAFENED">Deafened</span>
					<div data-i18n="DEAFENED_DESC">Cannot hear: hearing-based Perception fails.</div>
				</label>
				<label>
					<input type="checkbox" name="attr_affliction_defenseless" value="1">
					<span data-i18n="DEFENSELESS">Defenseless</span>
					<div data-i18n="DEFENSELESS_DESC">Defense becomes 5. Cannot use actions. Challenge rolls fail, except for Perception.</div>
				</label>
				<label>
					<input type="checkbox" name="attr_affliction_diseased" value="1">
					<span data-i18n="DISEASED">Diseased</span>
					<div data-i18n="DISEASED_DESC">All attack rolls and challenge rolls are made with 1 bane.</div>
				</label>
				<label>
					<input type="checkbox" name="attr_affliction_fatigued" value="1">
					<span data-i18n="FATIGUED">Fatigued</span>
					<div data-i18n="FATIGUED_DESC">All attack rolls and challenge rolls are made with 1 bane.</div>
				</label>
				<label>
					<input type="checkbox" name="attr_affliction_frightened" value="1">
					<span data-i18n="FRIGHTENED">Frightened</span>
					<div data-i18n="FRIGHTENED_DESC">All attack rolls and challenge rolls are made with 1 bane. Cannot take fast turns.</div>
				</label>
				<label>
					<input type="checkbox" name="attr_affliction_grabbed" value="1">
					<span data-i18n="GRABBED">Grabbed</span>
					<div data-i18n="GRABBED_DESC">Depending on size, either cannot move away (if grabber larger or equal), or move grabbing creature automatically.</div>
				</label>
				<label>
					<input type="checkbox" name="attr_affliction_immobilized" value="1">
					<span data-i18n="IMMOBILIZED">Immobilized</span>
					<div data-i18n="IMMOBILIZED_DESC">Speed becomes 0, cannot benefit from bonuses to speed. Attack rolls against get 1 boon.</div>
				</label>
				<label>
					<input type="checkbox" name="attr_affliction_impaired" value="1">
					<span data-i18n="IMPAIRED">Impaired</span>
					<div data-i18n="IMPAIRED_DESC">All attack rolls and challenge rolls are made with 1 bane.</div>
				</label>
				<label>
					<input type="checkbox" name="attr_affliction_poisoned" value="1">
					<span data-i18n="POISONED">Poisoned</span>
					<div data-i18n="POISONED_DESC">All attack rolls and challenge rolls are made with 1 bane.</div>
				</label>
				<label>
					<input type="checkbox" name="attr_affliction_prone" value="1">
					<span data-i18n="PRONE">Prone</span>
					<div data-i18n="PRONE_DESC">Lies on the ground. Other creatures can move through its space. Strength and Agility rolls are made with 1 bane. Attack rolls against get 1 boon or bane, depending on if they are in reach or not. Can use move to stand up.</div>
				</label>
				<label>
					<input type="checkbox" name="attr_affliction_slowed" value="1">
					<span data-i18n="SLOWED">Slowed</span>
					<div data-i18n="SLOWED_DESC">Can only take a slow turn. Speed is halved, cannot benefit from bonuses to speed.</div>
				</label>
				<label>
					<input type="checkbox" name="attr_affliction_stunned" value="1">
					<span data-i18n="STUNNED">Stunned</span>
					<div data-i18n="STUNNED_DESC">Cannot use actions or move. Challenge rolls fail. Attack rolls against are made with 1 boon.</div>
				</label>
				<label>
					<input type="checkbox" name="attr_affliction_surprised" value="1">
					<span data-i18n="SURPRISED">Surprised</span>
					<div data-i18n="SURPRISED_DESC">Cannot use actions or move. Challenge rolls fail.</div>
				</label>
				<label>
					<input type="checkbox" name="attr_affliction_unconscious" value="1">
					<span data-i18n="UNCONSCIOUS">Unconscious</span>
					<div data-i18n="UNCONSCIOUS_DESC">Cannot use actions or move. Challenge rolls fail. Defense becomes 5.</div>
				</label>
			</div>
		</div>
		<div class="sheet-right-col">
			<label>
				<div data-i18n="EQUIPMENT">Equipment</div>
				<div class="sheet-equipment-summary">
					<span name="attr_equipment_summary"></span>
				</div>
				<textarea spellcheck="false" name="attr_equipment_notes"></textarea>
			</label>
		</div>
	</div>
	<div class="sheet-row-3">
		<div class="sheet-weapons">
			<label class="sheet-edit-button">
				<input type="checkbox" name="attr_edit_mode" checked>
				<span>p</span>
			</label>
			<input type="checkbox" name="attr_edit_mode" class="sheet-hidden sheet-editmode" checked>
			<div class="sheet-header sheet-edit">
				<div class="sheet-fake-button"></div>
				<div class="sheet-name" data-i18n="WEAPON_NAME">Weapon Name</div>
				<div class="sheet-mod" data-i18n="MOD">Mod</div>
				<div class="sheet-damage" data-i18n="DAMAGE">Damage</div>
				<div class="sheet-boons" data-i18n="BOONS_BANES">Boons - Banes</div>
				<div class="sheet-properties" data-i18n="PROPERTIES">Properties</div>
			</div>
			<h3 class="sheet-display" data-i18n="WEAPONS">Weapons</h3>
			<fieldset class="repeating_weapons">
				<div class="sheet-edit">
					<label class="sheet-collapse">
						<input type="checkbox" name="attr_weapon_collapse" value="1">
						<span>y</span>
					</label>
					<div class="sheet-flex-row">
						<input type="hidden" name="attr_weapon_mod" value="+0">
						<input type="hidden" name="attr_weapon_against_display" value="">
						<button type="roll" name="roll_Attack" value="@{output_option} &{template:sotdl} {{title=@{weapon_name}}} {{name=@{name}}} {{attack=1}} {{attackroll=[[@{die_attack} + (@{weapon_mod}) + [[@{boons_banes_query} + @{weapon_boons_banes} + @{global_attack_boons} + @{global_weapon_attack_boons} - @{banes_from_afflictions}]]@{die_boon}k1[boons/banes]]]}} {{damage=@{weapon_damage}}} {{damageroll=[[0 + @{weapon_damage} + @{global_damage_bonus}[global bonus]]]}} {{versus=@{weapon_against}}} {{roll20plus=@{weapon_roll20plus}}} {{description=@{weapon_description}}}"></button>
						<input type="text" spellcheck="false" class="sheet-name" name="attr_weapon_name">
						<select name="attr_weapon_attribute" class="sheet-mod">
							<option value="strength" data-i18n="STRENGTH" selected>Strength</option>
							<option value="agility" data-i18n="AGILITY">Agility</option>
							<option value="intellect" data-i18n="INTELLECT">Intellect</option>
							<option value="will" data-i18n="WILL">Will</option>
						</select>
						<input type="text" spellcheck="false" class="sheet-damage" name="attr_weapon_damage" placeholder="1d6">
						<input type="number" value="0" step="1" name="attr_weapon_boons_banes" class="sheet-boons" value="0">
						<input type="text" spellcheck="false" class="sheet-properties" name="attr_weapon_properties">
					</div>
					<input type="checkbox" name="attr_weapon_collapse" class="sheet-hider sheet-hidden" value="1">
					<div class="sheet-flex-row sheet-weapon-details">
						<div class="sheet-fake-button"></div>
						<div class="sheet-versus">
							<span data-i18n="VS">vs</span>
							<select name="attr_weapon_against">
								<option value="^{STRENGTH}" data-i18n="STRENGTH">Strength</option>
								<option value="^{AGILITY}" data-i18n="AGILITY">Agility</option>
								<option value="^{INTELLECT}" data-i18n="INTELLECT">Intellect</option>
								<option value="^{WILL}" data-i18n="WILL">Will</option>
								<option value="^{DEFENSE}" data-i18n="DEFENSE" selected>Defense</option>
								<option value="^{PERCEPTION}" data-i18n="PERCEPTION">Perception</option>
							</select>
							<input type="text" spellcheck="false" name="attr_weapon_against" value="^{DEFENSE}">
						</div>
						<input type="text" spellcheck="false" class="sheet-roll20plus" name="attr_weapon_roll20plus" placeholder="Attack Roll 20+" data-i18n-placeholder="ATTACK_ROLL_20+">
						<textarea spellcheck="false" class="sheet-description" name="attr_weapon_description" placeholder="Description" data-i18n-placeholder="DESCRIPTION"></textarea>
					</div>
				</div>
				<div class="sheet-display">
					<button type="roll" name="roll_Attack" class="sheet-invisible-button" value="@{output_option} &{template:sotdl} {{title=@{weapon_name}}} {{name=@{name}}} {{attack=1}} {{attackroll=[[@{die_attack} + (@{weapon_mod}) + [[@{boons_banes_query} + @{weapon_boons_banes} + @{global_attack_boons} + @{global_weapon_attack_boons} - @{banes_from_afflictions}]]@{die_boon}k1[boons/banes]]]}} {{damage=@{weapon_damage}}} {{damageroll=[[0 + @{weapon_damage} + @{global_damage_bonus}[global bonus]]]}} {{versus=@{weapon_against}}} {{roll20plus=@{weapon_roll20plus}}} {{description=@{weapon_description}}}"></button>
					<span class="sheet-name" name="attr_weapon_name"></span>
					<input type="checkbox" name="attr_weapon_has_properties" class="sheet-hider sheet-hidden" value="1">
					<span>(<span name="attr_weapon_properties"></span>)</span>
					<span name="attr_weapon_mod"></span>
					<input type="checkbox" name="attr_weapon_has_boons_banes" class="sheet-hider sheet-hidden" value="1">
					<span><span data-i18n="WITH">with</span> <span name="attr_weapon_boons_banes"></span> <span class="sheet-lower" data-i18n="BOONS">boons</span></span>
					<span>(<span name="attr_weapon_damage"></span>)</span>
					<span name="attr_weapon_against_display"></span>
				</div>
			</fieldset>
		</div>
		<div class="sheet-right-col">
			<label class="sheet-fortunepoints">
				<span><span data-i18n="FORTUNE_POINTS">Fortune Points</span>:</span>
				<input type="number" value="0" step="1" name="attr_fortune_points" value="0">
			</label>
			<label data-i18n="AMMO">Ammo</label>
			<fieldset class="repeating_ammo">
				<input type="text" spellcheck="false" name="attr_ammo_name" class="sheet-name" placeholder="Arrows" data-i18n-placeholder="ARROWS">
				<input type="number" name="attr_ammo_amount">
			</fieldset>
		</div>
	</div>
</div>

<!-- Equipment and Talents -->
<input type="checkbox" name="attr_tab" class="sheet-hidden sheet-tab" value="equipment_talents">
<div class="sheet-equipment-talents sheet-pane sheet-secondary-tab">
	<div class="sheet-equipment">
		<div class="sheet-flex-row">
			<h3 data-i18n="EQUIPMENT">Equipment</h3>
			<label class="sheet-lifestyle">
				<span data-i18n="LIFESTYLE">Lifestyle</span>
				<input type="text" spellcheck="false" name="attr_lifestyle">
			</label>
		</div>
		<div class="sheet-coins">
			<label>
				<span data-i18n="BITS">bits</span>
				<input type="number" name="attr_bits" min="0" value="0">
			</label>
			<label>
				<span data-i18n="CP">cp</span>
				<input type="number" name="attr_copper" min="0" value="0">
			</label>
			<label>
				<span data-i18n="SS">ss</span>
				<input type="number" name="attr_silver" min="0" value="0">
			</label>
			<label>
				<span data-i18n="GC">gc</span>
				<input type="number" name="attr_gold" min="0" value="0">
			</label>
		</div>
		<div class="sheet-header">
			<div class="sheet-name" data-i18n="NAME">Name</div>
			<div class="sheet-amount" data-i18n="AMOUNT">Amount</div>
		</div>
		<fieldset class="repeating_items">
			<input type="text" spellcheck="false" class="sheet-name" name="attr_item_name" placeholder="Item name" data-i18n-placeholder="ITEM_NAME">
			<input type="number" value="1" min="0" class="sheet-amount" name="attr_item_amount">
		</fieldset>
		<div class="sheet-item-total">
			<div class="sheet-name" data-i18n="TOTAL">Total</div>
			<input type="number" value="0" class="sheet-amount sheet-no-spinners" name="attr_items_total" readonly>
		</div>
		<label class="sheet-notes">
			<div data-i18n="NOTES">Notes</div>
			<textarea spellcheck="false" name="attr_equipment_notes"></textarea>
		</label>
	</div>
	<input type="checkbox" name="attr_edit_mode" class="sheet-hidden sheet-editmode" checked>
	<div class="sheet-talents">
		<div class="sheet-flex-row">
			<h3 data-i18n="TALENTS">Talents</h3>
			<label class="sheet-pseudo-button sheet-reset-uses">
				<input type="checkbox" name="attr_reset_talent_uses" value="1">
				<span data-i18n="RESTORE_USES">Restore uses</span>
			</label>
		</div>
		<fieldset class="repeating_talents">
			<input type="checkbox" name="attr_talent_collapse" class="sheet-hidden sheet-collapse" value="1">
			<div class="sheet-edit">
				<label class="sheet-collapse">
					<input type="checkbox" name="attr_talent_collapse" value="1">
					<span>y</span>
				</label>
				<div class="sheet-flex-row">
					<label class="sheet-name">
						<div data-i18n="NAME">Name</div>
						<input type="text" spellcheck="false" name="attr_talent_name">
					</label>
					<label class="sheet-uses">
						<div data-i18n="USES">Uses</div>
						<input type="number" name="attr_talent_uses" value="0" min="0">
					</label>
					<label class="sheet-uses">
						<div data-i18n="MAX">Max</div>
						<input type="number" name="attr_talent_uses_max" value="0" min="0">
					</label>
					<button type="roll" class="sheet-talent-button" name="roll_Roll" value="@{output_option} &{template:sotdl} {{name=@{name}}} {{title=@{talent_name}}} {{attack=@{talent_attack_mod}}} {{attackroll=[[@{talent_attack_formula}]]}} {{versus=@{talent_against}}} {{damage=@{talent_damage}}} {{damageroll=[[0 + @{talent_damage}]]}} {{roll20plus=@{talent_roll20plus}}} {{description=@{talent_description}}}"></button>
				</div>
				<div class="sheet-flex-row">
					<label class="sheet-field-quarter">
						<div data-i18n="ATTACK">Attack</div>
						<select name="attr_talent_attack_mod">
							<option value="" data-i18n="NONE" selected>None</option>
							<option value="@{strength_mod}" data-i18n="STRENGTH">Strength</option>
							<option value="@{agility_mod}" data-i18n="AGILITY">Agility</option>
							<option value="@{intellect_mod}" data-i18n="INTELLECT">Intellect</option>
							<option value="@{will_mod}" data-i18n="WILL">Will</option>
						</select>
					</label>
					<label class="sheet-field-quarter sheet-versus">
						<div data-i18n="AGAINST">Against</div>
						<select name="attr_talent_against">
							<option value="" data-i18n="NONE" selected>None</option>
							<option value="^{STRENGTH}" data-i18n="STRENGTH">Strength</option>
							<option value="^{AGILITY}" data-i18n="AGILITY">Agility</option>
							<option value="^{INTELLECT}" data-i18n="INTELLECT">Intellect</option>
							<option value="^{WILL}" data-i18n="WILL">Will</option>
							<option value="^{DEFENSE}" data-i18n="DEFENSE">Defense</option>
							<option value="^{PERCEPTION}" data-i18n="PERCEPTION">Perception</option>
						</select>
						<input type="text" spellcheck="false" name="attr_talent_against">
					</label>
					<label class="sheet-field-quarter">
						<div data-i18n="DAMAGE">Damage</div>
						<input type="text" spellcheck="false" name="attr_talent_damage">
					</label>
					<label class="sheet-field-quarter">
						<div data-i18n="BOONS_BANES">Boons - Banes</div>
						<input type="number" name="attr_talent_boons_banes" value="0">
					</label>
				</div>
				<input type="checkbox" name="attr_talent_has_attack" class="sheet-hider sheet-hidden" value="1">
				<label>
					<div data-i18n="ATTACK_ROLL_20+">Attack Roll 20+</div>
					<input type="text" spellcheck="false" name="attr_talent_roll20plus">
				</label>
				<label class="sheet-description">
					<div data-i18n="DESCRIPTION">Description</div>
					<textarea spellcheck="false" name="attr_talent_description"></textarea>
				</label>
			</div>
			<div class="sheet-display">
				<button type="roll" name="roll_Roll" class="sheet-invisible-button" value="@{output_option} &{template:sotdl} {{name=@{name}}} {{title=@{talent_name}}} {{attack=@{talent_attack_mod}}} {{attackroll=[[@{talent_attack_formula}]]}} {{versus=@{talent_against}}} {{damage=@{talent_damage}}} {{damageroll=[[0 + @{talent_damage}]]}} {{roll20plus=@{talent_roll20plus}}} {{description=@{talent_description}}}"></button>
				<input type="checkbox" name="attr_talent_has_uses" class="sheet-hidden sheet-uses-check" value="1">
				<input type="checkbox" name="attr_talent_has_roll20plus" class="sheet-hidden sheet-roll20plus" value="1">
				<input type="hidden" name="attr_talent_attack_formula" value="0">
				<div class="sheet-display-header">
					<span name="attr_talent_name"></span>
					<input type="number" name="attr_talent_uses" class="sheet-uses sheet-uses-display" min="0" value="0">
					<span class="sheet-uses-display">/</span>
					<span name="attr_talent_uses_max" class="sheet-uses-display">1</span>
				</div>
				<div class="sheet-display-text">
					<div class="sheet-description sheet-linebreak"><span name="attr_talent_description"></span></div>
					<div class="sheet-roll20plus">
						<strong data-i18n="ATTACK_ROLL_20+">Attack Roll 20+</strong>
						<span name="attr_talent_roll20plus"></span>
					</div>
				</div>
			</div>
		</fieldset>
	</div>
</div>

<!-- Spells -->
<input type="checkbox" name="attr_tab" class="sheet-hidden sheet-tab" value="spells">
<div class="sheet-spells sheet-pane sheet-secondary-tab">
	<input type="checkbox" name="attr_edit_mode" class="sheet-hidden sheet-editmode" checked>
	<div class="sheet-flex-row">
		<h3 data-i18n="TRADITIONS">Traditions</h3>
		<label class="sheet-pseudo-button sheet-reset-castings">
			<input type="checkbox" name="attr_reset_spell_castings" value="1">
			<span data-i18n="RESTORE_CASTINGS">Restore castings</span>
		</label>
	</div>
	<div class="sheet-traditions">
		<fieldset class="repeating_traditions">
			<div class="sheet-flex-row sheet-edit">
				<input type="text" spellcheck="false" name="attr_tradition_name" class="sheet-name" placeholder="Name" data-i18n-placeholder="NAME">
				<select name="attr_tradition_attribute" class="sheet-attribute">
					<option value="INTELLECT" data-i18n="INTELLECT">Intellect</option>
					<option value="WILL" data-i18n="WILL">Will</option>
				</select>
				<input type="text" spellcheck="false" name="attr_tradition_description" class="sheet-description" placeholder="Description" data-i18n-placeholder="DESCRIPTION">
			</div>
			<span class="sheet-display">
				<span class="sheet-name" name="attr_tradition_name"></span>
				(<span name="attr_tradition_attribute" data-i18n-dynamic></span><input type="checkbox" name="attr_tradition_has_description" class="sheet-hidden sheet-hider" value="1"><span>;
				<span name="attr_tradition_description"></span></span>)</span>
		</fieldset>
	</div>
	<h3 data-i18n="SPELLS">Spells</h3>
	<div class="sheet-spell-content">
		<fieldset class="repeating_spells">
			<input type="checkbox" name="attr_spell_collapse" class="sheet-hidden sheet-collapse" value="1">
			<div class="sheet-edit">
				<label class="sheet-collapse">
					<input type="checkbox" name="attr_spell_collapse" value="1">
					<span>y</span>
				</label>
				<div class="sheet-flex-row">
					<label class="sheet-field-long">
						<div data-i18n="SPELL">Spell</div>
						<input type="text" spellcheck="false" name="attr_spell_name">
					</label>
					<label class="sheet-field-short">
						<div data-i18n="TRADITION">Tradition</div>
						<input type="text" spellcheck="false" name="attr_spell_tradition">
					</label>
					<label class="sheet-field-short">
						<div data-i18n="TYPE">Type</div>
						<select name="attr_spell_type">
							<option value="ATTACK" data-i18n="ATTACK" selected>Attack</option>
							<option value="UTILITY" data-i18n="UTILITY">Utility</option>
						</select>
					</label>
					<label class="sheet-field-number">
						<div data-i18n="RANK">Rank</div>
						<input type="number" name="attr_spell_rank" value="0" min="0" max="9">
					</label>
					<label class="sheet-field-short">
						<div data-i18n="ATTRIBUTE">Attribute</div>
						<select name="attr_spell_attribute">
							<option value=" (^{INTELLECT})" data-i18n="INTELLECT" selected>Intellect</option>
							<option value=" (^{WILL})" data-i18n="WILL">Will</option>
							<option value=" " data-i18n="NONE">None</option>
						</select>
					</label>
					<label class="sheet-field-number">
						<div data-i18n="CASTINGS">Castings</div>
						<input type="number" name="attr_spell_castings" value="0" min="0">
					</label>
					<div class="sheet-slash">/</div>
					<label class="sheet-field-number">
						<input type="number" name="attr_spell_castings_max" value="1" min="0">
					</label>
					<button type="roll" name="roll_Cast" value="@{output_option} &{template:sotdl} {{spell=1}} {{name=@{name}}} {{title=@{spell_name}}} {{subtitle=@{spell_tradition} ^{@{spell_type}} @{spell_rank} @{spell_attribute}}} @{spell_sacrifice_query} {{attack=@{spell_attack_mod}}} {{attackroll=[[@{spell_attack_formula}]]}} {{versus=@{spell_against}}} {{damage=@{spell_damage}}} {{damageroll=[[0 + @{spell_damage}]]}} {{target=@{spell_target}}} {{area=@{spell_area}}} {{duration=@{spell_duration}}} {{requirement=@{spell_requirement}}} {{description=@{spell_description}}} {{triggered=@{spell_triggered}}} {{roll20plus=@{spell_roll20plus}}} {{permanence=@{spell_permanence}}} {{aftereffect=@{spell_aftereffect}}} {{special=@{spell_special}}}"></button>
				</div>
				<div class="sheet-flex-row">
					<label class="sheet-field-quarter">
						<div data-i18n="DURATION">Duration</div>
						<textarea spellcheck="false" name="attr_spell_duration"></textarea>
					</label>
					<label class="sheet-field-quarter">
						<div data-i18n="TARGET">Target</div>
						<textarea spellcheck="false" name="attr_spell_target"></textarea>
					</label>
					<label class="sheet-field-quarter">
						<div data-i18n="AREA">Area</div>
						<textarea spellcheck="false" name="attr_spell_area"></textarea>
					</label>
					<label class="sheet-field-quarter">
						<div data-i18n="REQUIREMENT">Requirement</div>
						<textarea spellcheck="false" name="attr_spell_requirement"></textarea>
					</label>
				</div>
				<div class="sheet-flex-row">
					<label class="sheet-field-quarter">
						<div data-i18n="SACRIFICE">Sacrifice</div>
						<textarea spellcheck="false" name="attr_spell_sacrifice"></textarea>
					</label>
					<label class="sheet-field-quarter">
						<div data-i18n="PERMANENCE">Permanence</div>
						<textarea spellcheck="false" name="attr_spell_permanence"></textarea>
					</label>
					<label class="sheet-field-quarter">
						<div data-i18n="AFTEREFFECT">Aftereffect</div>
						<textarea spellcheck="false" name="attr_spell_aftereffect"></textarea>
					</label>
					<label class="sheet-field-quarter">
						<div data-i18n="SPECIAL">Special</div>
						<textarea spellcheck="false" name="attr_spell_special"></textarea>
					</label>
				</div>
				<div class="sheet-flex-row">
					<label class="sheet-field-half">
						<div data-i18n="DESCRIPTION">Description</div>
						<textarea spellcheck="false" name="attr_spell_description"></textarea>
					</label>
					<label class="sheet-field-half">
						<div data-i18n="TRIGGERED">Triggered</div>
						<textarea spellcheck="false" name="attr_spell_triggered"></textarea>
					</label>
				</div>
				<div class="sheet-flex-row">
					<label class="sheet-field-short">
						<div data-i18n="ATTACK">Attack</div>
						<select name="attr_spell_attack_mod">
							<option value="" data-i18n="NONE" selected>None</option>
							<option value="@{strength_mod}" data-i18n="STRENGTH">Strength</option>
							<option value="@{agility_mod}" data-i18n="AGILITY">Agility</option>
							<option value="@{intellect_mod}" data-i18n="INTELLECT">Intellect</option>
							<option value="@{will_mod}" data-i18n="WILL">Will</option>
						</select>
					</label>
					<label class="sheet-field-short sheet-versus">
						<div data-i18n="AGAINST">Against</div>
						<select name="attr_spell_against">
							<option value="" data-i18n="NONE" selected>None</option>
							<option value="^{STRENGTH}" data-i18n="STRENGTH">Strength</option>
							<option value="^{AGILITY}" data-i18n="AGILITY">Agility</option>
							<option value="^{INTELLECT}" data-i18n="INTELLECT">Intellect</option>
							<option value="^{WILL}" data-i18n="WILL">Will</option>
							<option value="^{DEFENSE}" data-i18n="DEFENSE">Defense</option>
							<option value="^{PERCEPTION}" data-i18n="PERCEPTION">Perception</option>
						</select>
						<input type="text" spellcheck="false" name="attr_spell_against">
					</label>
					<label class="sheet-field-short">
						<div data-i18n="DAMAGE">Damage</div>
						<input type="text" spellcheck="false" name="attr_spell_damage">
					</label>
					<label class="sheet-field-short">
						<div data-i18n="BOONS_BANES">Boons - Banes</div>
						<input type="number" name="attr_spell_boons_banes" value="0">
					</label>
					<label class="sheet-field-half">
						<div data-i18n="ATTACK_ROLL_20+">Attack Roll 20+</div>
						<input type="text" spellcheck="false" name="attr_spell_roll20plus">
					</label>
				</div>
			</div>
			<div class="sheet-display">
				<button type="roll" name="roll_Cast" class="sheet-invisible-button" value="@{output_option} &{template:sotdl} {{spell=1}} {{name=@{name}}} {{title=@{spell_name}}} {{subtitle=@{spell_tradition} ^{@{spell_type}} @{spell_rank} @{spell_attribute}}} @{spell_sacrifice_query} {{attack=@{spell_attack_mod}}} {{attackroll=[[@{spell_attack_formula}]]}} {{versus=@{spell_against}}} {{damage=@{spell_damage}}} {{damageroll=[[0 + @{spell_damage}]]}} {{target=@{spell_target}}} {{area=@{spell_area}}} {{duration=@{spell_duration}}} {{requirement=@{spell_requirement}}} {{description=@{spell_description}}} {{triggered=@{spell_triggered}}} {{roll20plus=@{spell_roll20plus}}} {{permanence=@{spell_permanence}}} {{aftereffect=@{spell_aftereffect}}} {{special=@{spell_special}}}"></button>
				<input type="checkbox" name="attr_spell_has_requirement" class="sheet-hidden sheet-requirement" value="1">
				<input type="checkbox" name="attr_spell_has_target" class="sheet-hidden sheet-target" value="1">
				<input type="checkbox" name="attr_spell_has_area" class="sheet-hidden sheet-area" value="1">
				<input type="checkbox" name="attr_spell_has_duration" class="sheet-hidden sheet-duration" value="1">
				<input type="checkbox" name="attr_spell_has_triggered" class="sheet-hidden sheet-triggered" value="1">
				<input type="checkbox" name="attr_spell_has_roll20plus" class="sheet-hidden sheet-roll20plus" value="1">
				<input type="checkbox" name="attr_spell_has_sacrifice" class="sheet-hidden sheet-sacrifice" value="1">
				<input type="checkbox" name="attr_spell_has_permanence" class="sheet-hidden sheet-permanence" value="1">
				<input type="checkbox" name="attr_spell_has_aftereffect" class="sheet-hidden sheet-aftereffect" value="1">
				<input type="checkbox" name="attr_spell_has_special" class="sheet-hidden sheet-special" value="1">
				<input type="hidden" name="attr_spell_attack_formula" value="0">
				<input type="hidden" name="attr_spell_sacrifice_query" value="">
				<div class="sheet-display-header">
					<span name="attr_spell_name"></span>
					<span name="attr_spell_tradition"></span>
					<span name="attr_spell_type" data-i18n-dynamic></span>
					<span name="attr_spell_rank"></span>
					<input type="number" name="attr_spell_castings" class="sheet-uses" min="0" value="0">
					<span>/</span>
					<span name="attr_spell_castings_max">1</span>
				</div>
				<div class="sheet-display-info">
					<div class="sheet-requirement">
						<strong data-i18n="REQUIREMENT">Requirement</strong>
						<span name="attr_spell_requirement"></span>
					</div>
					<div class="sheet-target">
						<strong data-i18n="TARGET">Target</strong>
						<span name="attr_spell_target"></span>
					</div>
					<div class="sheet-area">
						<strong data-i18n="AREA">Area</strong>
						<span name="attr_spell_area"></span>
					</div>
					<div class="sheet-duration">
						<strong data-i18n="DURATION">Duration</strong>
						<span name="attr_spell_duration"></span>
					</div>
				</div>
				<div class="sheet-display-text">
					<div class="sheet-description sheet-linebreak"><span name="attr_spell_description"></span></div>
					<div class="sheet-triggered">
						<strong data-i18n="TRIGGERED">Triggered</strong>
						<span class="sheet-linebreak" name="attr_spell_triggered"></span>
					</div>
					<div class="sheet-roll20plus">
						<strong data-i18n="ATTACK_ROLL_20+">Attack Roll 20+</strong>
						<span class="sheet-linebreak" name="attr_spell_roll20plus"></span>
					</div>
					<div class="sheet-sacrifice">
						<strong data-i18n="SACRIFICE">Sacrifice</strong>
						<span class="sheet-linebreak" name="attr_spell_sacrifice"></span>
					</div>
					<div class="sheet-permanence">
						<strong data-i18n="PERMANENCE">Permanence</strong>
						<span class="sheet-linebreak" name="attr_spell_permanence"></span>
					</div>
					<div class="sheet-aftereffect">
						<strong data-i18n="AFTEREFFECT">Aftereffect</strong>
						<span class="sheet-linebreak" name="attr_spell_aftereffect"></span>
					</div>
					<div class="sheet-special">
						<strong data-i18n="SPECIAL">Special</strong>
						<span class="sheet-linebreak" name="attr_spell_special"></span>
					</div>
				</div>
			</div>
			</fieldset>
	</div>
</div>

<!-- Background -->
<input type="checkbox" name="attr_tab" class="sheet-hidden sheet-tab" value="background">
<div class="sheet-background sheet-pane sheet-secondary-tab">
	<input type="checkbox" name="attr_edit_mode" class="sheet-hidden sheet-editmode" checked>
	<h3 data-i18n="BACKGROUND">Background</h3>
	<div class="sheet-left-col">
		<fieldset class="repeating_background">
			<div class="sheet-edit">
				<input type="text" spellcheck="false" name="attr_background_name" placeholder="Name" data-i18-placeholder="NAME">
				<textarea spellcheck="false" name="attr_background_description" placeholder="Details" data-i18-placeholder="DETAILS"></textarea>
			</div>
			<div class="sheet-indent-container sheet-display">
				<span class="sheet-name" name="attr_background_name"></span>
				<span class="sheet-linebreak" name="attr_background_description"></span>
			</div>
		</fieldset>
	</div>
	<div class="sheet-right-col">
		<div class="sheet-edit">
			<span class="sheet-name" data-i18n="NOVICE_TRAINING">Novice training</span>
			<textarea spellcheck="false" name="attr_novice_training"></textarea>
		</div>
		<div class="sheet-indent-container sheet-display">
			<span class="sheet-name" data-i18n="NOVICE_TRAINING">Novice training</span>
			<span class="sheet-linebreak" name="attr_novice_training"></span>
		</div>
		<div class="sheet-edit">
			<span class="sheet-name" data-i18n="EXPERT_DEVELOPMENT">Expert development</span>
			<textarea spellcheck="false" name="attr_expert_development"></textarea>
		</div>
		<div class="sheet-indent-container sheet-display">
			<span class="sheet-name" data-i18n="EXPERT_DEVELOPMENT">Expert development</span>
			<span class="sheet-linebreak" name="attr_expert_development"></span>
		</div>
		<div class="sheet-edit">
			<span class="sheet-name" data-i18n="EXPERT_OBJECTIVE">Expert objective</span>
			<textarea spellcheck="false" name="attr_expert_objective"></textarea>
		</div>
		<div class="sheet-indent-container sheet-display">
			<span class="sheet-name" data-i18n="EXPERT_OBJECTIVE">Expert objective</span>
			<span class="sheet-linebreak" name="attr_expert_objective"></span>
		</div>
		<div class="sheet-edit">
			<span class="sheet-name" data-i18n="MASTER_DEVELOPMENT">Master development</span>
			<textarea spellcheck="false" name="attr_master_development"></textarea>
		</div>
		<div class="sheet-indent-container sheet-display">
			<span class="sheet-name" data-i18n="MASTER_DEVELOPMENT">Master development</span>
			<span class="sheet-linebreak" name="attr_master_development"></span>
		</div>
		<div class="sheet-edit">
			<span class="sheet-name" data-i18n="MASTER_QUEST">Master quest</span>
			<textarea spellcheck="false" name="attr_master_quest"></textarea>
		</div>
		<div class="sheet-indent-container sheet-display">
			<span class="sheet-name" data-i18n="MASTER_QUEST">Master quest</span>
			<span class="sheet-linebreak" name="attr_master_quest"></span>
		</div>
		<label class="sheet-notes">
			<div class="sheet-indent-container">
				<span class="sheet-name" data-i18n="NOTES">Notes</span>
				<span class="sheet-display sheet-linebreak" name="attr_background_notes"></span>
			</div>
			<textarea spellcheck="false" class="sheet-edit" name="attr_background_notes" placeholder="Notes" data-i18n-placeholder="NOTES"></textarea>
		</label>
	</div>
</div>

<!-- NPC -->
<input type="checkbox" name="attr_tab" class="sheet-hidden sheet-tab" value="npc">
<div class="sheet-npc sheet-pane sheet-secondary-tab">
	<input type="checkbox" name="attr_edit_mode" class="sheet-hidden sheet-editmode" checked>
	<div class="sheet-left-col">
		<input type="text" spellcheck="false" name="attr_name" placeholder="Name" class="sheet-monster-header sheet-edit sheet-name" data-i18n-placeholder="NAME">
		<div class="sheet-monster-header sheet-display">
			<span name="attr_name" class="sheet-name"></span>
			<span data-i18n="DIFFICULTY">Difficulty</span>
			<span name="attr_difficulty" class="sheet-difficulty"></span>
		</div>
		<div class="sheet-flex-row sheet-edit">
			<label class="sheet-field-stat">
				<div data-i18n="DIFFICULTY">Difficulty</div>
				<input type="number" name="attr_difficulty" placeholder="1">
			</label>
			<label class="sheet-field-short">
				<div data-i18n="SIZE">Size</div>
				<input type="text" spellcheck="false" name="attr_size" value="1">
			</label>
			<label class="sheet-field-tags">
				<div data-i18n="TAGS">Tags</div>
				<input type="text" spellcheck="false" name="attr_tags" data-i18n-placeholder="TAGS_PLACEHOLDER" placeholder="[frightening/horrifying] descriptor (special)">
			</label>
		</div>
		<div class="sheet-flex-row sheet-edit">
			<label class="sheet-field-stat">
				<div data-i18n="PERCEPTION">Perception</div>
				<input type="number" name="attr_perception" value="10" min="0">
			</label>
			<label class="sheet-field-senses">
				<div data-i18n="SPECIAL_SENSES">Special senses</div>
				<input type="text" spellcheck="false" name="attr_special_senses" placeholder="darksight" data-i18n-placeholder="SENSES_PLACEHOLDER">
			</label>
			<label class="sheet-field-stat">
				<div data-i18n="DEFENSE">Defense</div>
				<input type="number" name="attr_defense" value="10" min="0">
			</label>
			<label class="sheet-field-armor">
				<div data-i18n="ARMOR">Armor</div>
				<input type="text" spellcheck="false" name="attr_npc_armor" placeholder="mail" data-i18n-placeholder="ARMOR_PLACEHOLDER">
			</label>
		</div>
		<div class="sheet-flex-row sheet-edit">
			<label class="sheet-field-stat">
				<div data-i18n="HEALTH">Health</div>
				<input type="number" name="attr_health" value="10" min="0">
			</label>
			<input type="checkbox" name="attr_has_strength" class="sheet-hider sheet-attr-check" value="1" checked>
			<label class="sheet-field-stat">
				<div data-i18n="STRENGTH">Strength</div>
				<input type="number" name="attr_strength" value="10" min="0">
			</label>
			<input type="checkbox" name="attr_has_agility" class="sheet-hider sheet-attr-check" value="1" checked>
			<label class="sheet-field-stat">
				<div data-i18n="AGILITY">Agility</div>
				<input type="number" name="attr_agility" value="10" min="0">
			</label>
			<input type="checkbox" name="attr_has_intellect" class="sheet-hider sheet-attr-check" value="1" checked>
			<label class="sheet-field-stat">
				<div data-i18n="INTELLECT">Intellect</div>
				<input type="number" name="attr_intellect" value="10" min="0">
			</label>
			<input type="checkbox" name="attr_has_will" class="sheet-hider sheet-attr-check" value="1" checked>
			<label class="sheet-field-stat">
				<div data-i18n="WILL">Will</div>
				<input type="number" name="attr_will" value="10" min="0">
			</label>
		</div>
		<div class="sheet-flex-row sheet-edit">
			<label class="sheet-field-stat">
				<div data-i18n="SPEED">Speed</div>
				<input type="number" name="attr_speed" value="10" min="0">
			</label>
			<label class="sheet-field-movement">
				<div data-i18n="SPECIAL MOVEMENT">Special movement traits</div>
				<input type="text" name="attr_special_movement" placeholder="flier" data-i18n-placeholder="MOVEMENT_PLACEHOLDER">
			</label>
		</div>
		<div class="sheet-tags sheet-display">
			<span data-i18n="SIZE">Size</span>
			<span name="attr_size"></span>
			<span name="attr_tags"></span>
		</div>
		<div class="sheet-indent-container sheet-display">
			<div>
				<span class="sheet-button-holder">
					<button name="roll_Perception" class="sheet-invisible-button" type="roll" value="@{output_option} &{template:sotdl} {{name=@{name}}} {{title=^{PERCEPTION}}} {{roll=[[@{die_challenge} + (@{perception_mod}) + [[@{boons_banes_query} + @{global_challenge_boons} - @{banes_from_afflictions}]]@{die_boon}k1[boons/banes]]]}}"></button>
					<span>
						<strong data-i18n="PERCEPTION">Perception</strong>
						<span name="attr_perception"></span>
						(<span name="attr_perception_mod"></span>)</span></span><input type="checkbox" name="attr_has_special_senses" class="sheet-hider sheet-hidden" value="1"><span>; <span name="attr_special_senses"></span></span>
			</div>
			<div>
				<strong data-i18n="DEFENSE">Defense</strong>
				<span name="attr_defense"></span><input type="checkbox" name="attr_has_npc_armor" class="sheet-hider sheet-hidden" value="1"><span> (<span name="attr_npc_armor"></span>)</span>;
				<strong data-i18n="HEALTH">Health</strong>
				<span name="attr_health"></span>;
				<strong data-i18n="DAMAGE">Damage</strong>
				<input type="number" name="attr_damage" class="sheet-inline-input" value="0">
			</div>
			<div>
				<input type="checkbox" name="attr_has_strength" class="sheet-hider sheet-hidden" value="1" checked>
				<span class="sheet-button-holder">
					<button name="roll_Strength" class="sheet-invisible-button" type="roll" value="@{output_option} &{template:sotdl} {{name=@{name}}} {{title=^{STRENGTH}}} {{roll=[[@{die_challenge} + (@{strength_mod}) + [[@{boons_banes_query} + @{global_challenge_boons} - @{banes_from_afflictions}]]@{die_boon}k1[boons/banes]]]}}"></button>
					<span>
						<strong data-i18n="STRENGTH">Strength</strong>
						<span name="attr_strength"></span>
						(<span name="attr_strength_mod"></span>),</span>
				</span>
				<input type="checkbox" name="attr_has_strength" class="sheet-hider sheet-hidden" value="0">
				<span><strong data-i18n="STRENGTH">Strength</strong> —,</span>
				<input type="checkbox" name="attr_has_agility" class="sheet-hider sheet-hidden" value="1" checked>
				<span class="sheet-button-holder">
					<button name="roll_Agility" class="sheet-invisible-button" type="roll" value="@{output_option} &{template:sotdl} {{name=@{name}}} {{title=^{AGILITY}}} {{roll=[[@{die_challenge} + (@{agility_mod}) + [[@{boons_banes_query} + @{global_challenge_boons} - @{banes_from_afflictions}]]@{die_boon}k1[boons/banes]]]}}"></button>
					<span>
						<strong data-i18n="AGILITY">Agility</strong>
						<span name="attr_agility"></span>
						(<span name="attr_agility_mod"></span>),</span>
				</span>
				<input type="checkbox" name="attr_has_agility" class="sheet-hider sheet-hidden" value="0">
				<span><strong data-i18n="AGILITY">Agility</strong> —,</span>
				<input type="checkbox" name="attr_has_intellect" class="sheet-hider sheet-hidden" value="1" checked>
				<span class="sheet-button-holder">
					<button name="roll_Intellect" class="sheet-invisible-button" type="roll" value="@{output_option} &{template:sotdl} {{name=@{name}}} {{title=^{INTELLECT}}} {{roll=[[@{die_challenge} + (@{intellect_mod}) + [[@{boons_banes_query} + @{global_challenge_boons} - @{banes_from_afflictions}]]@{die_boon}k1[boons/banes]]]}}"></button>
					<span>
						<strong data-i18n="INTELLECT">Intellect</strong>
						<span name="attr_intellect"></span>
						(<span name="attr_intellect_mod"></span>),</span>
				</span>
				<input type="checkbox" name="attr_has_intellect" class="sheet-hider sheet-hidden" value="0">
				<span><strong data-i18n="INTELLECT">Intellect</strong> —,</span>
				<input type="checkbox" name="attr_has_will" class="sheet-hider sheet-hidden" value="1" checked>
				<span class="sheet-button-holder">
					<button name="roll_Will" class="sheet-invisible-button" type="roll" value="@{output_option} &{template:sotdl} {{name=@{name}}} {{title=^{WILL}}} {{roll=[[@{die_challenge} + (@{will_mod}) + [[@{boons_banes_query} + @{global_challenge_boons} - @{banes_from_afflictions}]]@{die_boon}k1[boons/banes]]]}}"></button>
					<span>
						<strong data-i18n="WILL">Will</strong>
						<span name="attr_will"></span>
						(<span name="attr_will_mod"></span>)</span>
				</span>
				<input type="checkbox" name="attr_has_will" class="sheet-hider sheet-hidden" value="0">
				<span><strong data-i18n="WILL">Will</strong> —,</span>
			</div>
			<div>
				<strong data-i18n="SPEED">Speed</strong>
				<span name="attr_speed"></span><input type="checkbox" name="attr_has_special_movement" class="sheet-hider sheet-hidden" value="1"><span>; <span name="attr_special_movement"></span></span>
			</div>
		</div>
		<fieldset class="repeating_npctraits">
			<div class="sheet-edit">
				<input type="text" spellcheck="false" name="attr_npctrait_name" class="sheet-name" placeholder="Trait name" data-i18n-placeholder="TRAIT_NAME">
				<textarea spellcheck="false" name="attr_npctrait_description" placeholder="Trait description" data-i18n-placeholder="TRAIT_DESCRIPTION"></textarea>
			</div>
			<div class="sheet-indent-container sheet-display">
				<button type="roll" name="roll_Roll" class="sheet-invisible-button" value="@{output_option} &{template:sotdl} {{name=@{name}}} {{title=@{npctrait_name}}} {{description=@{npctrait_description}}}"></button>
				<input type="hidden" name="attr_npctrait_name">
				<input type="hidden" name="attr_npctrait_description">
				<span class="sheet-label" name="attr_npctrait_name"></span>
				<span class="sheet-linebreak" name="attr_npctrait_description"></span>
			</div>
		</fieldset>
	</div>
	<div class="sheet-right-col">
		<div class="sheet-attacks">
			<div class="sheet-npc-header">
				<span data-i18n="ATTACKS">Attacks</span>
			</div>
			<fieldset class="repeating_attacks">
				<div class="sheet-flex-row sheet-edit">
					<input type="text" spellcheck="false" class="sheet-name" name="attr_attack_name" placeholder="Name" data-i18n-placeholder="NAME">
					<span>(</span>
					<input type="text" spellcheck="false" class="sheet-range" name="attr_attack_range" placeholder="melee or short range" data-i18n-placeholder="RANGE_PLACEHOLDER">
					<span>; <span class="sheet-lower" data-i18n="REACH">reach</span> +</span>
					<input type="number" class="sheet-reach" name="attr_attack_reach" value="0">
					<span>)</span>
					<span>+</span>
					<input type="number" name="attr_attack_mod" class="sheet-mod" value="0">
				</div>
				<div class="sheet-flex-row sheet-edit">
					<span data-i18n="WITH">with</span>
					<input type="number" name="attr_attack_boons" class="sheet-boons" value="0">
					<span class="sheet-lower" data-i18n="BOONS">boons</span><span> (</span>
					<input type="text" spellcheck="false" name="attr_attack_damage" class="sheet-damage" placeholder="1d6">
					<span data-i18n="PLUS">plus</span>
					<input type="text" spellcheck="false" name="attr_attack_plus" class="sheet-extra" placeholder="extra effect" data-i18n-placeholder="EXTRA_EFFECT">
					<span>)</span>
					<span class="sheet-versus">
						<span data-i18n="VS">vs</span>
						<select name="attr_attack_against">
							<option value="^{STRENGTH}" data-i18n="STRENGTH">Strength</option>
							<option value="^{AGILITY}" data-i18n="AGILITY">Agility</option>
							<option value="^{INTELLECT}" data-i18n="INTELLECT">Intellect</option>
							<option value="^{WILL}" data-i18n="WILL">Will</option>
							<option value="^{DEFENSE}" data-i18n="DEFENSE" selected>Defense</option>
							<option value="^{PERCEPTION}" data-i18n="PERCEPTION">Perception</option>
						</select>
						<input type="text" spellcheck="false" name="attr_attack_against" value="^{DEFENSE}">
					</span>
				</div>
				<textarea spellcheck="false" name="attr_attack_description" class="sheet-edit" placeholder="Description" data-i18n-placeholder="DESCRIPTION"></textarea>
				<div class="sheet-indent-container sheet-display">
					<button type="roll" name="roll_Roll" class="sheet-invisible-button" value="@{output_option} &{template:sotdl} {{title=@{attack_name}}} {{subtitle=@{attack_range}}} {{name=@{name}}} {{attack=@{attack_range}}} {{attackroll=[[@{attack_formula}]]}} {{damage=@{attack_damage}}} {{damageroll=[[0 + @{attack_damage} + @{global_damage_bonus}[global bonus]]]}} {{damageplus=@{attack_plus}}} {{description=@{attack_description}}} {{versus=@{attack_against}}}"></button>
					<input type="hidden" name="attr_attack_formula" value="0">
					<input type="hidden" name="attr_attack_against_display" value="">
					<span class="sheet-label" name="attr_attack_name"></span>
					<input type="checkbox" name="attr_attack_has_range" class="sheet-hider sheet-hidden" value="1">
					<span>(<span name="attr_attack_range"></span><input type="checkbox" name="attr_attack_has_reach" class="sheet-hider sheet-hidden" value="1"><span>;
					<span class="sheet-lower" data-i18n="REACH">reach</span>
					+<span name="attr_attack_reach"></span></span>)</span>
					<input type="checkbox" name="attr_attack_has_range" class="sheet-hider sheet-hidden" value="1">
					<span>+<span name="attr_attack_mod"></span>
					<input type="checkbox" name="attr_attack_has_boons" class="sheet-hider sheet-hidden" value="1">
					<span>
						<span data-i18n="WITH">with</span>
						<span name="attr_attack_boons"></span>
						<span class="sheet-lower" data-i18n="BOONS">boons</span>
					</span></span>
					<input type="checkbox" name="attr_attack_has_damage" class="sheet-hider sheet-hidden" value="1">
					<span>(<span name="attr_attack_damage"></span><input type="checkbox" name="attr_attack_has_plus" class="sheet-hider sheet-hidden" value="1"><span>
					<span data-i18n="PLUS">plus</span>
					<span name="attr_attack_plus"></span></span>)
					</span>
					<span name="attr_attack_against_display"></span>
					<span class="sheet-linebreak" name="attr_attack_description"></span>
				</div>
			</fieldset>
		</div>
		<input type="checkbox" name="attr_has_specialattacks" class="sheet-display-hider sheet-hidden" value="1">
		<div class="sheet-specialattacks">
			<div class="sheet-npc-header" data-i18n="SPECIAL_ATTACKS">Special attacks</div>
			<fieldset class="repeating_specialattacks">
				<div class="sheet-edit">
					<input type="text" spellcheck="false" name="attr_specialattack_name" class="sheet-name" placeholder="Name" data-i18n-placeholder="NAME">
					<textarea spellcheck="false" name="attr_specialattack_description" placeholder="Description" data-i18n-placeholder="DESCRIPTION"></textarea>
				</div>
				<div class="sheet-indent-container sheet-display">
					<button type="roll" name="roll_Roll" class="sheet-invisible-button" value="@{output_option} &{template:sotdl} {{name=@{name}}} {{title=@{specialattack_name}}} {{description=@{specialattack_description}}}"></button>
					<input type="hidden" name="attr_specialattack_name">
					<input type="hidden" name="attr_specialattack_description">
					<span class="sheet-label" name="attr_specialattack_name"></span>
					<span class="sheet-linebreak" name="attr_specialattack_description"></span>
				</div>
			</fieldset>
		</div>
		<input type="checkbox" name="attr_has_specialactions" class="sheet-display-hider sheet-hidden" value="1">
		<div class="sheet-specialactions">
			<div class="sheet-npc-header" data-i18n="SPECIAL_ACTIONS">Special actions</div>
			<fieldset class="repeating_specialactions">
				<div class="sheet-edit">
					<input type="text" spellcheck="false" name="attr_specialaction_name" class="sheet-name" placeholder="Name" data-i18n-placeholder="NAME">
					<textarea spellcheck="false" name="attr_specialaction_description" placeholder="Description" data-i18n-placeholder="DESCRIPTION"></textarea>
				</div>
				<div class="sheet-indent-container sheet-display">
					<button type="roll" name="roll_Roll" class="sheet-invisible-button" value="@{output_option} &{template:sotdl} {{name=@{name}}} {{title=@{specialaction_name}}} {{description=@{specialaction_description}}}"></button>
					<input type="hidden" name="attr_specialaction_name">
					<input type="hidden" name="attr_specialaction_description">
					<span class="sheet-label" name="attr_specialaction_name"></span>
					<span class="sheet-linebreak" name="attr_specialaction_description"></span>
				</div>
			</fieldset>
		</div>
		<input type="checkbox" name="attr_has_npcmagic" class="sheet-display-hider sheet-hidden" value="1">
		<div class="sheet-npcmagic">
			<div class="sheet-npc-header" data-i18n="MAGIC">Magic</div>
			<label class="sheet-power sheet-edit">
				<span data-i18n="POWER">Power</span>
				<input type="number" name="attr_power" value="0" min="0">
			</label>
			<div class="sheet-indent-container sheet-display">
				<strong data-i18n="POWER">Power</strong>
				<span name="attr_power"></span>
			</div>
			<fieldset class="repeating_npcmagic">
				<div class="sheet-flex-row sheet-edit">
					<input type="text" spellcheck="false" name="attr_npcmagic_name" class="sheet-tradition-name sheet-name" placeholder="Tradition" data-i18n-placeholder="TRADITION">
					<input type="text" spellcheck="false" name="attr_npcmagic_spells" class="sheet-tradition-spells" placeholder="Spells" data-i18n-placeholder="SPELLS">
				</div>
				<div class="sheet-indent-container sheet-display">
					<span class="sheet-label" name="attr_npcmagic_name"></span>
					<span class="sheet-italic" name="attr_npcmagic_spells"></span>
				</div>
			</fieldset>
		</div>
		<input type="checkbox" name="attr_has_endofround" class="sheet-display-hider sheet-hidden" value="1">
		<div class="sheet-endofround">
			<div class="sheet-npc-header" data-i18n="END_OF_THE_ROUND">End of the round</div>
			<fieldset class="repeating_endofround">
				<div class="sheet-edit">
					<input type="text" spellcheck="false" class="sheet-name" name="attr_endofround_name" placeholder="Name" data-i18n-placeholder="NAME">
					<textarea spellcheck="false" name="attr_endofround_description" placeholder="Description" data-i18n-placeholder="DESCRIPTION"></textarea>
				</div>
				<div class="sheet-indent-container sheet-display">
					<button type="roll" name="roll_Roll" class="sheet-invisible-button" value="@{output_option} &{template:sotdl} {{name=@{name}}} {{title=@{endofround_name}}} {{description=@{endofround_description}}}"></button>
					<input type="hidden" name="attr_endofround_name">
					<input type="hidden" name="attr_endofround_description">
					<span class="sheet-label" name="attr_endofround_name"></span>
					<span class="sheet-linebreak" name="attr_endofround_description"></span>
				</div>
			</fieldset>
		</div>
	</div>
</div>

<rolltemplate class="sheet-rolltemplate-sotdl">
	{{#title}}<div class="sheet-title">
		<div>{{title}}</div>
		{{#subtitle}}<div class="sheet-subtitle">{{subtitle}}</div>{{/subtitle}}
	</div>{{/title}}
	{{#name}}<div class="sheet-name">{{name}}</div>{{/name}}
	{{^sacrifice}}<div class="sheet-rolls">
		{{#attack}}<div class="sheet-attack">
			<span class="sheet-label" data-i18n="ATTACK">Attack</span>: {{attackroll}}
			{{#versus}}<span data-i18n="VS">vs</span><span class="sheet-vs"> {{versus}}</span>{{/versus}}
		</div>{{/attack}}{{#damage}}<div class="sheet-damage">
			<span class="sheet-label" data-i18n="DAMAGE">Damage</span>: {{damageroll}}
		</div>{{/damage}}{{#damageplus}}<div class="sheet-damageplus">
			<span data-i18n="PLUS">plus</span><span> {{damageplus}}</span>
		</div>{{/damageplus}}{{#roll}}<div class="sheet-roll">
			<span class="sheet-label" data-i18n="ROLL">Roll</span>: {{roll}}
		</div>{{/roll}}
	</div>{{/sacrifice}}
	{{#spell}}{{^sacrifice}}<div class="sheet-spell-info">
		{{#requirement}}<div>
			<strong data-i18n="REQUIREMENT">Requirement</strong> {{requirement}}
		</div>{{/requirement}}{{#target}}<div>
			<strong data-i18n="TARGET">Target</strong> {{target}}
		</div>{{/target}}{{#area}}<div>
			<strong data-i18n="AREA">Area</strong> {{area}}
		</div>{{/area}}{{#duration}}<div>
			<strong data-i18n="DURATION">Duration</strong> {{duration}}
		</div>{{/duration}}
	</div>{{/sacrifice}}{{/spell}}
	<div class="sheet-content">{{^sacrifice}}
		{{#description}}<div class="sheet-description">
			{{description}}
		</div>{{/description}}{{#triggered}}<div>
			<strong data-i18n="TRIGGERED">Triggered</strong> {{triggered}}
		</div>{{/triggered}}{{#rollGreater() attackroll 19}}{{#roll20plus}}<div>
			<strong data-i18n="ATTACK_ROLL_20+">Attack Roll 20+</strong> {{roll20plus}}
		</div>{{/roll20plus}}{{/rollGreater() attackroll 19}}{{/sacrifice}}{{#sacrifice}}<div>
			<strong data-i18n="SACRIFICE">Sacrifice</strong> {{sacrifice}}
		</div>{{/sacrifice}}{{^sacrifice}}{{#permanence}}<div>
			<strong data-i18n="PERMANENCE">Permanence</strong> {{permanence}}
		</div>{{/permanence}}{{#aftereffect}}<div>
			<strong data-i18n="AFTEREFFECT">Aftereffect</strong> {{aftereffect}}
		</div>{{/aftereffect}}{{#special}}<div>
			<strong data-i18n="SPECIAL">Special</strong> {{special}}
		</div>{{/special}}{{/sacrifice}}
	</div>
</rolltemplate>

<script type="text/worker">
// Utility
const setAttr = (attr, value) => {
	const attrs = {};
	attrs[attr] = value;
	setAttrs(attrs);
};
// Calculate equipment totals, summary
on('change:repeating_items remove:repeating_items', () => {
	"use strict";
	getSectionIDs('repeating_items', idArray => {
		const sectionAttrs = [
			...idArray.map(id => `repeating_items_${id}_item_amount`),
			...idArray.map(id => `repeating_items_${id}_item_name`)
			];
		getAttrs(sectionAttrs, v => {
			const total = idArray.map(id => `repeating_items_${id}_item_amount`)
				.reduce((m, n) => (m + (parseInt(v[n]) || 0)), 0);
			const summary = idArray.map(id => {
				const prefix = `repeating_items_${id}_item`,
					number = (v[`${prefix}_amount`] === '1') ? '' : v[`${prefix}_amount`] + ' ';
				return number + v[`${prefix}_name`];
			}).join(', ');
			setAttrs({
				items_total: total,
				equipment_summary: summary,
			});
		});
	});
});

// Calculate stat mods
const stats = ['strength', 'agility', 'intellect', 'perception', 'will'];
const calculateStatBonus = stat => {
	getAttrs([stat], v => {
		const mod = (parseInt(v[stat]) - 10) || 0;
		setAttr(`${stat}_mod`, (mod >= 0) ? `+${mod}` : mod);
	});
};
stats.forEach(stat => on(`change:${stat}`, () => calculateStatBonus(stat)));

// Handle display attributes for weapons
const weaponDisplay = ['boons_banes', 'properties'];
weaponDisplay.forEach(name => {
	on(`change:repeating_weapons:weapon_${name}`, event => {
		const newValue = (name === 'boons_banes') ? parseInt(event.newValue) : event.newValue;
		setAttr(`repeating_weapons_weapon_has_${name}`, newValue ? '1' : '0');
	});
});
const calcWeaponMod = prefix => {
	getAttrs(['strength_mod', 'agility_mod', 'intellect_mod', 'will_mod', `${prefix}_weapon_attribute`], v => {
		setAttr(`${prefix}_weapon_mod`, v[v[`${prefix}_weapon_attribute`] + '_mod']);
	});
};
on('change:repeating_weapons', () => calcWeaponMod('repeating_weapons'));
on('change:strength_mod change:agility_mod change:intellect_mod change:will_mod', () => {
	getSectionIDs('repeating_weapons', idArray => idArray.forEach(id => calcWeaponMod(`repeating_weapons_${id}`)));
});

// Handle display settings for spells and traditions
const spellDisplay = ['requirement', 'target', 'area', 'duration', 'triggered', 'roll20plus', 'sacrifice', 'permanence', 'aftereffect', 'special'];
spellDisplay.forEach(name => {
	on(`change:repeating_spells:spell_${name}`, event => {
		setAttr(`repeating_spells_spell_has_${name}`, event.newValue ? '1' : '0');
	});
});
// Sacrifice query
on('change:repeating_spells:spell_sacrifice', () => {
	getAttrs(['repeating_spells_spell_sacrifice'], v => {
		const query = v.repeating_spells_spell_sacrifice ? `{{?{${getTranslationByKey('SACRIFICE_SPELL')}|${getTranslationByKey('NO')},` +
			`sacrifice=|${getTranslationByKey('YES')},sacrifice=@{spell_sacrifice}}}}` : '';
		setAttr('repeating_spells_spell_sacrifice_query', query);
	});
});
// Tradition description display
on('change:repeating_traditions:tradition_description', event => {
	setAttr(`repeating_traditions_tradition_has_description`, event.newValue ? '1' : '0');
});

// Handle spell attack rolls
const spellAttackFormula = '@{die_attack} + (@{spell_attack_mod}) + [[@{boons_banes_query} + @{spell_boons_banes} + @{global_attack_boons} + @{global_spell_attack_boons} - @{banes_from_afflictions}]]@{die_boon}k1[boons/banes]';
on('change:repeating_spells:spell_attack_mod', event => {
	getAttrs(['repeating_spells_spell_attack_mod'], v => {
		setAttr('repeating_spells_spell_attack_formula', v.repeating_spells_spell_attack_mod ? spellAttackFormula : '0');
	});
});
// Handle talent attack rolls
const talentAttackFormula = '@{die_attack} + (@{talent_attack_mod}) + [[@{boons_banes_query} + @{talent_boons_banes} + @{global_attack_boons} - @{banes_from_afflictions}]]@{die_boon}k1[boons/banes]';
on('change:repeating_talents:talent_attack_mod', event => {
	getAttrs(['repeating_talents_talent_attack_mod'], v => {
		setAttr('repeating_talents_talent_attack_formula', v.repeating_talents_talent_attack_mod ? talentAttackFormula : '0');
	});
});

// Calculate spell max castings
const getSpellCastings = (rk, pwr, exp) => {
	const rank = parseInt(rk) || 0,
		power = parseInt(pwr) || 0,
		expertise = parseInt(exp) || 0;

	if (power < rank) return '0';
	else if (rank >= 6) return '1';
	else if (rank === 5) {
		if (power >= 8) return '2';
		else return '1';
	}
	else if (rank >= 2) {
		if ((power - rank) >= 6) return '3';
		else if ((power - rank) >= 2) return '2';
		else return '1';
	}
	else if (rank === 1) {
		if (power >= 5) return String(3 + expertise);
		else if (power >= 2) return  String(2 + expertise);
		else return  String(1 + expertise);
	}
	else if (rank === 0) return String(power + expertise + 1);
};
const calcSpellCastings = prefix => {
	getAttrs([`${prefix}_rank`, 'power', 'setting_auto_spell_castings', 'setting_spell_expertise'], v => {
		if (v.setting_auto_spell_castings === '1') {
			setAttr(`${prefix}_castings_max`, getSpellCastings(v[`${prefix}_rank`], v.power, v.setting_spell_expertise));
		}
	});
};
on('change:power change:setting_auto_spell_castings change:setting_spell_expertise', () => {
	getSectionIDs('repeating_spells', idArray => {
		idArray.forEach(id => calcSpellCastings(`repeating_spells_${id}_spell`));
	});
});
on('change:repeating_spells:spell_rank', () => {
	calcSpellCastings('repeating_spells_spell');
});

// Handle display of talent uses
on('change:repeating_talents:talent_uses', event => {
	getAttrs(['repeating_talents_talent_uses', 'repeating_talents_talent_uses_max'], v => {
		const uses = parseInt(v['repeating_talents_talent_uses']) || 0,
			max = parseInt(v['repeating_talents_talent_uses_max']) || 0;
		setAttr('repeating_talents_talent_has_uses', (uses !== 0 || max !== 0) ? '1' : '0');
	});
});
// Handle display of talent roll20+
on('change:repeating_talents:talent_roll20plus', event => {
	setAttr(`repeating_talents_talent_has_roll20plus`, event.newValue ? '1' : '0');
});
on('change:repeating_talents:talent_attack_mod', event => {
	setAttr(`repeating_talents_talent_has_attack`, event.newValue ? '1' : '0');
});

// Handle reset of spell castings
const resetSpellCastings = () => {
	getSectionIDs('repeating_spells', idArray => {
		getAttrs(idArray.map(id => `repeating_spells_${id}_spell_castings_max`), v => {
			const attrs = idArray.reduce((m, id) => {
				m[`repeating_spells_${id}_spell_castings`] = v[`repeating_spells_${id}_spell_castings_max`] || '1';
				return m;
			}, {});
			setAttrs(attrs);
		});
	});
};
on('change:reset_spell_castings', resetSpellCastings);

// Handle reset of talent uses
const resetTalentUses = () => {
	getSectionIDs('repeating_talents', idArray => {
		getAttrs(idArray.map(id => `repeating_talents_${id}_talent_uses_max`), v => {
			const attrs = idArray.reduce((m, id) => {
				if (v[`repeating_talents_${id}_talent_uses_max`] && v[`repeating_talents_${id}_talent_uses_max`] !== '0') {
					m[`repeating_talents_${id}_talent_uses`] = v[`repeating_talents_${id}_talent_uses_max`] || '0';
				}
				return m;
			}, {});
			setAttrs(attrs);
		});
	});
};
on('change:reset_talent_uses', resetTalentUses);

// Set max damage and healing rate
const handleHealthChange = () => {
	getAttrs(['health', 'setting_healing_rate_divisor'], v => {
		setAttrs({
			damage_max: v.health,
			healing_rate: (Math.floor((parseInt(v.health)) / v.setting_healing_rate_divisor)) || 0,
		});
	});
};
on('change:health change:setting_healing_rate_divisor', handleHealthChange);

// Handle banes from afflictions
const baneAfflictions = ['diseased', 'fatigued', 'frightened', 'impaired', 'poisoned'];
on(baneAfflictions.map(x => `change:affliction_${x}`).join(' '), () => {
	getAttrs(baneAfflictions.map(x => `affliction_${x}`), v => {
		setAttr('banes_from_afflictions', Object.values(v).reduce((m, k) => (m + (parseInt(k) || 0)), 0));
	});
});

// Weapon/attack against display
['weapon', 'attack'].forEach(name => {
	on(`change:repeating_${name}s:${name}_against`, event => {
		const dName = `repeating_${name}s_${name}_against_display`,
			newValue = event.newValue.toLowerCase()
			dot = (name === 'attack') ? "." : "";
		if (newValue.indexOf('strength') >= 0) {
			setAttr(dName, `${getTranslationByKey('VS')} ${getTranslationByKey('STRENGTH')}${dot}`);
		} else if (newValue.indexOf('agility') >= 0) {
			setAttr(dName, `${getTranslationByKey('VS')} ${getTranslationByKey('AGILITY')}${dot}`);
		} else if (newValue.indexOf('intellect') >= 0) {
			setAttr(dName, `${getTranslationByKey('VS')} ${getTranslationByKey('INTELLECT')}${dot}`);
		} else if (newValue.indexOf('will') >= 0) {
			setAttr(dName, `${getTranslationByKey('VS')} ${getTranslationByKey('WILL')}${dot}`);
		} else if (newValue.indexOf('perception') >= 0) {
			setAttr(dName, `${getTranslationByKey('VS')} ${getTranslationByKey('PERCEPTION')}${dot}`);
		} else {
			setAttr(dName, '');
		}
	});
});

// NPC hiding/showing sections
on('change:npc', event => setAttr('tab', (event.newValue === '1') ? 'npc' : 'main'));
['special_senses', 'npc_armor', 'special_movement'].forEach(name => {
	on(`change:${name}`, event => {
		setAttr(`has_${name}`, event.newValue ? '1' : '0');
	});
});
['specialactions', 'specialattacks', 'npcmagic', 'endofround'].forEach(sName => {
	on(`change:repeating_${sName} remove:repeating_${sName}`, () => {
		getSectionIDs(`repeating_${sName}`, idArray => {
			setAttr(`has_${sName}`, idArray.length ? '1' : '0');
		});
	});
});
['range', 'reach', 'boons', 'damage', 'plus'].forEach(name => {
	on(`change:repeating_attacks:attack_${name}`, event => {
		const newValue = (name === 'reach' || name === 'boons') ?
			parseInt(event.newValue) : event.newValue;
		setAttr(`repeating_attacks_attack_has_${name}`, newValue ? '1' : '0');
	});
});

// NPC attacks
const npcAttackAttrs = ['range', 'mod', 'boons'];
on(npcAttackAttrs.map(x => `change:repeating_attacks:attack_${x}`).join(' '), () => {
	const prefix = 'repeating_attacks_attack';
	getAttrs(npcAttackAttrs.map(x => `${prefix}_${x}`), v => {
		setAttr(`${prefix}_formula`, v[`${prefix}_range`] ? `@{die_attack} + (${v[prefix + '_mod']}) + ` +
			`[[@{boons_banes_query} + ${v[prefix + '_boons']} + @{global_attack_boons}]]@{die_boon}k1[boons/banes]` : '0');
	});
});

// Version upgrades
const fillRepeatingSectionFromData = (sName, data, callback) => {
	callback = callback || (() => {});
	const createdIDs = [],
		setting = data.map(o => {
			let rowID;
			while (!rowID) {
				let newID = generateRowID();
				if (!createdIDs.includes(newID)) {
					rowID = newID;
					createdIDs.push(rowID);
				}
			}
			return Object.keys(o).reduce((m, key) => {
				m[`repeating_${sName}_${rowID}_${key}`] = String(o[key]);
				return m;
			}, {});
		})
		.reduce((m, o) => Object.assign(m, o), {});
	setAttrs(setting, {}, callback);
};
const upgradeSheet = currentVersion => {
	// Upgradee to v2: convert different standards for spell attributes
	if (currentVersion < 2) {
		const upgradeFunction = _.after(2, () => upgradeSheet(2));
		// Update repeating_spells_spell_attribute
		getSectionIDs('repeating_spells', idArray => {
			oldAttrs = [
				...idArray.map(id => `repeating_spells_${id}_spell_attribute`),
				...idArray.map(id => `repeating_spells_${id}_spell_sacrifice`),
				...idArray.map(id => `repeating_spells_${id}_spell_against`),
			];
			getAttrs(oldAttrs, v => {
				const attrs = {};
				idArray.forEach(id => {
					switch(v[`repeating_spells_${id}_spell_attribute`]) {
					case 'INTELLECT':
						attrs[`repeating_spells_${id}_spell_attribute`] = ' (^{INTELLECT})';
						break;
					case 'WILL':
						attrs[`repeating_spells_${id}_spell_attribute`] = ' (^{WILL})';
					}
					if (v[`repeating_spells_${id}_spell_sacrifice`]) {
						attrs[`repeating_spells_${id}_spell_sacrifice_query`] = `{{?{${getTranslationByKey('SACRIFICE_SPELL')}|${getTranslationByKey('NO')},` +
							`sacrifice=|${getTranslationByKey('YES')},sacrifice=@{spell_sacrifice}}}}`;
					}
					if (v[`repeating_spells_${id}_spell_against`] && String(v[`repeating_spells_${id}_spell_against`]).indexOf('^') !== 0) {
						attrs[`repeating_spells_${id}_spell_against`] = '^{' + v[`repeating_spells_${id}_spell_against`] + '}';
					}
				});
				setAttrs(attrs, {}, upgradeFunction);
			});
		});
		getSectionIDs('repeating_weapons', idArray => {
			const oldAttrs = [
				...idArray.map(id => `repeating_weapons_${id}_weapon_mod`),
				...idArray.map(id => `repeating_weapons_${id}_weapon_properties`),
				...idArray.map(id => `repeating_weapons_${id}_weapon_boons_banes`),
			];
			getAttrs(oldAttrs, v => {
				const attrs = {};
				idArray.forEach(id => {
					const oldMod = v[`repeating_weapons_${id}_weapon_mod`];
					if (oldMod && oldMod.indexOf('@') === 0) {
						attrs[`repeating_weapons_${id}_weapon_attribute`] = oldMod.slice(2, -5);
					}
					if (v[`repeating_weapons_${id}_weapon_properties`]) {
						attrs[`repeating_weapons_${id}_weapon_has_properties`] = '1';
					}
					if (parseInt(v[`repeating_weapons_${id}_weapon_boons_banes`])) {
						attrs[`repeating_weapons_${id}_weapon_has_boons_banes`] = '1';
					}
				});
				setAttrs(attrs, {}, () => {
					upgradeFunction();
					idArray.forEach(id => calcWeaponMod(`repeating_weapons_${id}`));
				});
			});
		});
	}
};
const initialiseSheet = () => {
	// Convert from pre-sheet workers version below
	const convert = (obj, oldValue, newName) => {
		if (oldValue) obj[newName] = String(oldValue);
	}
	const upgradeFunction = _.after(4, () => upgradeSheet(1));
	// Convert non-repeating attributes
	const simpleConversion = {
		desc: "description",
		lvl: "level",
		prof: "professions",
		talents: "notes",
		equipment: "equipment_notes",
		dboonsbanes: "fortune_points",
	};
	getAttrs(Object.keys(simpleConversion), v => {
		const attrs = {};
		Object.keys(simpleConversion).forEach(oldName => {
			convert(attrs, v[oldName], simpleConversion[oldName]);
		});
		attrs.tab = 'main';
		setAttrs(attrs, {}, upgradeFunction);
	});
	// Convert attributes in repeating sections
	getSectionIDs('repeating_weapons', idArray => {
		const oldAttrs = [
			...idArray.map(id => `repeating_weapons_${id}_attrtype`),
			...idArray.map(id => `repeating_weapons_${id}_ddamage`),
			...idArray.map(id => `repeating_weapons_${id}_dboonsbanes`),
		];
		getAttrs(oldAttrs, v => {
			const attrs = {};
			idArray.forEach(id => {
				convert(attrs, v[`repeating_weapons_${id}_ddamage`], `repeating_weapons_${id}_weapon_damage`);
				convert(attrs, v[`repeating_weapons_${id}_dboonsbanes`], `repeating_weapons_${id}_weapon_boons_banes`);
				switch (v[`repeating_weapons_${id}_attrtype`]) {
				case '@{agility}':
					attrs[`repeating_weapons_${id}_weapon_mod`] = '@{agility_mod}';
					break;
				default:
					attrs[`repeating_weapons_${id}_weapon_mod`] = '@{strength_mod}';
				}
			});
			setAttrs(attrs, {}, upgradeFunction);
		});
	});
	getSectionIDs('repeating_magic', idArray => {
		const convData = {
			spell: "spell_name",
			stradition: "spell_tradition",
			sduration: "spell_duration",
			sreq: "spell_requirement",
			srank: "spell_rank",
			suses: "spell_castings",
			smax: "spell_castings_max",
			starget: "spell_target",
			sdescription: "spell_description",
			striggered: "spell_triggered",
			srollagainsttype: "spell_against",
			sdamage: "spell_damage",
			sbonus: "spell_roll20plus",
		};
		const oldAttrs = idArray.reduce((m, id) => {
			return m.concat(Object.keys(convData).map(x => `repeating_magic_${id}_${x}`));
		}, []).concat(idArray.map(id => `repeating_magic_${id}_srolltype`));
		getAttrs(oldAttrs, v => {
			let hasOldMax = false;
			const data = idArray.map(id => {
				const row = {};
				if (v[`repeating_magic_${id}_smax`]) hasOldMax = true;
				Object.keys(convData).forEach(oldName => {
					convert(row, v[`repeating_magic_${id}_${oldName}`], convData[oldName]);
				});
				switch (v[`repeating_magic_${id}_srolltype`]) {
				case '@{strength}':
					row.spell_attack_mod = '@{strength_mod}';
					break;
				case '@{agility}':
					row.spell_attack_mod = '@{agility_mod}';
					break;
				case '@{intellect}':
					row.spell_attack_mod = '@{intellect_mod}';
					break;
				case '@{will}':
					row.spell_attack_mod = '@{will_mod}';
					break;
				default:
					row.spell_attack_mod = '';
				}
				spellDisplay.forEach(name => {
					row[`has_spell_${name}`] = row[`spell_${name}`] ? '1' : '0';
				});
				if (row.spell_against) row.spell_against = row.spell_against.toUpperCase();
				row.spell_attack_formula = row.spell_attack_mod ? spellAttackFormula : '0';
				return row;
			});
			setAttrs({
				setting_auto_spell_castings: (hasOldMax) ? '0' : '1'
			}, {}, () => fillRepeatingSectionFromData('spells', data, upgradeFunction));
			idArray.forEach(id => removeRepeatingRow(`repeating_magic_${id}`));
		});
	});
	getSectionIDs('repeating_talents', idArray => {
		const convData = {
			talent: "talent_name",
			tuses: "talent_uses",
			tmax: "talent_uses_max",
			tdescription: "talent_description",
		};
		const oldAttrs = idArray.reduce((m, id) => {
			return m.concat(Object.keys(convData).map(x => `repeating_talents_${id}_${x}`));
		}, []);
		getAttrs(oldAttrs, v => {
			const attrs = {};
			idArray.forEach(id => {
				Object.keys(convData).forEach(oldName => {
					convert(attrs, v[`repeating_talents_${id}_${oldName}`], `repeating_talents_${id}_${convData[oldName]}`);
				});
				if (attrs[`repeating_talents_${id}_talent_uses_max`] !== '0' ||
					attrs[`repeating_talents_${id}_talent_uses`] !== '0') {
					attrs[`repeating_talents_${id}_talent_has_uses`] = '1';
				}
			});
			setAttrs(attrs, {}, upgradeFunction);
		});
	});
	// Re-calculate mods
	stats.forEach(calculateStatBonus);
	handleHealthChange();
};
const setBoonsBanesQuery = () => {
	getAttrs(['boons_banes_query'], v => {
		const newValue = `?{#(${getTranslationByKey('BOONS_BANES')})|0}`;
		if (newValue !== v.boons_banes_query) setAttr('boons_banes_query', newValue);
	});
};
const setWhisperQuery = () => {
	getAttrs(['whisper_query'], v => {
		const newValue = `?{${getTranslationByKey('OUTPUT')}|${getTranslationByKey('PUBLIC')}, |${getTranslationByKey('WHISPERED_TO_GM')},/w GM}`;
		if (newValue !== v.whisper_query) setAttr('whisper_query', newValue);
	});
};

on('sheet:opened', () => {
	getAttrs(['version'], v => {
		const version = parseInt(v.version) || 0;
		if (!version) initialiseSheet();
		else upgradeSheet(version);
		setAttr('version', '2');
	});
	setBoonsBanesQuery();
	setWhisperQuery();
});
</script>
